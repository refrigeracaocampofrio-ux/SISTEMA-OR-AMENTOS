<<!doctype html>
<html lang="pt-BR">
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
    />
    <title>Refrigeração Campo Frio - Sistema OS v4.0-ORCAMENTOS</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root {
        --primary: #3498db;
        --secondary: #1a1a2e;
        --success: #27ae60;
        --danger: #e74c3c;
        --warning: #f39c12;
        --info: #1abc9c;
        --dark-bg: #0f0f1e;
        --dark-card: #16213e;
        --dark-sidebar: #1a1a2e;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--dark-bg);
        overflow-x: hidden;
        color: #e0e0e0;
        position: relative;
      }

      body::before {
        content: '';
        position: fixed;
        bottom: 0;
        right: 0;
        width: 700px;
        height: 700px;
        background-image: url('/imagens/logo-rcf.png');
        background-repeat: no-repeat;
        background-position: bottom right;
        background-size: 500px 500px;
        opacity: 0.1;
        pointer-events: none;
        z-index: 0;
        margin-right: -100px;
        margin-bottom: -100px;
      }

      .sidebar {
        width: 250px;
        min-height: calc(100vh - 56px);
        transition: all 0.3s;
        background: var(--dark-sidebar);
        color: white;
        border-right: 1px solid rgba(52, 152, 219, 0.2);
      }

      .sidebar .nav-link {
        color: #bbb;
        padding: 12px 20px;
        border-left: 4px solid transparent;
        transition: all 0.2s;
      }

      .sidebar .nav-link:hover {
        color: white;
        background: rgba(52, 152, 219, 0.15);
        border-left-color: var(--primary);
      }

      .sidebar .nav-link.active {
        color: white;
        background: rgba(52, 152, 219, 0.25);
        border-left-color: var(--primary);
      }

      .main-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        max-height: calc(100vh - 56px);
        background: var(--dark-bg);
        position: relative;
        z-index: 1;
      }

      .aba-conteudo {
        animation: fadeIn 0.3s;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      // trocarContaGoogle não é mais necessário (link direto)

      .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.3);
        margin-bottom: 20px;
        transition: transform 0.2s;
        background: var(--dark-card);
        color: #e0e0e0;
      }

      .card:hover {
        transform: translateY(-2px);
      }

      .card-header {
        background: #1e2a3a !important;
        border-bottom: 1px solid rgba(52, 152, 219, 0.3);
        font-weight: 600;
        padding: 15px 20px;
        color: #e0e0e0 !important;
      }

      .dashboard-card {
        padding: 20px;
        border-radius: 10px;
        color: white;
        text-align: center;
        margin-bottom: 15px;
        transition: all 0.3s;
      }

      .dashboard-card:hover {
        transform: scale(1.02);
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        cursor: pointer;
        transition: all 0.2s;
      }

      .status-orcamento {
        background: #ffeaa7;
        color: #d35400;
      }
      .status-aprovado {
        background: #55efc4;
        color: #2d3436;
      }
      .status-aberto {
        background: #a29bfe;
        color: #2d3436;
      }
      .status-andamento {
        background: #81ecec;
        color: #2d3436;
      }
      .status-concluido {
        background: #55efc4;
        color: #2d3436;
      }
      .status-pago {
        background: #a29bfe;
        color: #2d3436;
      }
      .status-cancelado {
        background: #fd79a8;
        color: #2d3436;
      }

      .table-hover tbody tr {
        transition: all 0.2s;
        cursor: pointer;
      }

      .table-hover tbody tr:hover {
        background-color: rgba(52, 152, 219, 0.15);
      }

      .form-control,
      .form-select {
        background-color: #1e2a3a;
        border: 1px solid #2d3e50;
        color: #e0e0e0;
      }

      .form-control:focus,
      .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        background-color: #1e2a3a;
        color: #e0e0e0;
      }

      .form-control::placeholder {
        color: #888;
      }

      .table {
        color: #e0e0e0;
      }

      .table-striped > tbody > tr:nth-of-type(odd) > * {
        background-color: rgba(255, 255, 255, 0.02);
      }

      .modal-content {
        background-color: var(--dark-card);
        color: #ffffff;
      }

      .modal-header {
        background: linear-gradient(135deg, var(--dark-sidebar) 0%, var(--primary) 100%);
        color: #ffffff;
        border-bottom: 1px solid rgba(52, 152, 219, 0.3);
      }

      .modal-footer {
        border-top: 1px solid rgba(52, 152, 219, 0.3);
      }

      .modal-body,
      .modal-body label,
      .modal-body input,
      .modal-body select,
      .modal-body textarea,
      .modal-body p,
      .modal-body span {
        color: #ffffff !important;
      }

      .form-label {
        font-weight: 600;
        color: #c0c0c0;
        margin-bottom: 5px;
      }

      .btn-primary {
        background: var(--primary);
        border: none;
        padding: 10px 25px;
        font-weight: 600;
      }

      .btn-primary:hover {
        background: #2980b9;
        transform: translateY(-1px);
      }

      .btn-success {
        background: var(--success);
        border: none;
        padding: 10px 25px;
        font-weight: 600;
      }

      .btn-success:hover {
        background: #219653;
        transform: translateY(-1px);
      }

      .btn-sm {
        padding: 5px 15px;
        font-size: 13px;
      }

      .btn-outline-danger {
        border-color: var(--danger);
        color: var(--danger);
      }

      .btn-outline-danger:hover {
        background: var(--danger);
        color: white;
      }

      .alert-card {
        border-left: 5px solid;
        padding: 15px;
        margin-bottom: 10px;
        background: #16213e;
        border-radius: 5px;
      }

      .alert-danger {
        border-color: var(--danger);
      }
      .alert-warning {
        border-color: var(--warning);
      }
      .alert-success {
        border-color: var(--success);
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(52, 152, 219, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary);
        animation: spin 1s ease-in-out infinite;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 768px) {
        .sidebar {
          width: 70px;
        }
        .sidebar .nav-link span:not(.badge) {
          display: none;
        }
        .sidebar .nav-link {
          text-align: center;
          padding: 15px 10px;
        }
        .sidebar .nav-link i {
          margin-right: 0;
          font-size: 1.2rem;
        }
        .main-content {
          padding: 10px;
        }
      }

      .badge {
        font-size: 11px;
        padding: 4px 8px;
      }

      .table td,
      .table th {
        vertical-align: middle;
        padding: 12px 15px;
        border-color: rgba(52, 152, 219, 0.2);
      }

      .table-responsive {
        border-radius: 8px;
        overflow: hidden;
      }

      .form-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
      }

      .search-box {
        position: relative;
      }

      .search-box i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #95a5a6;
      }

      .search-box input {
        padding-left: 45px;
      }

      .toast {
        background: #1a1a2e;
        border-left: 4px solid var(--primary);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        color: #e0e0e0;
      }

      .toast-body {
        background: #1a1a2e;
        color: #e0e0e0;
      }

      .toast-header {
        background: #16213e !important;
        border-bottom: 1px solid rgba(52, 152, 219, 0.2);
      }

      .modal-header {
        background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
        color: white;
      }

      .navbar-brand {
        color: #ffffff !important;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(52, 152, 219, 0.08);
        padding: 6px 10px;
        border-radius: 20px;
        border: 1px solid rgba(52, 152, 219, 0.3);
      }

      .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #3498db;
        color: #ffffff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .user-name {
        color: #ffffff;
        font-weight: 600;
        max-width: 160px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }

      .action-buttons .btn {
        padding: 4px 8px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <script>
      // Patch global fetch to include Authorization header automatically
      (function(){
        if (window._authWrapped) return;
        const origFetch = window.fetch.bind(window);
        window.fetch = function(resource, init){
          init = init || {};
          init.headers = init.headers || {};
          try {
            const token = localStorage.getItem('token');
            const isSameOrigin = (typeof resource === 'string') ? resource.startsWith('/') || resource.startsWith(location.origin) : true;
            if (token && isSameOrigin && !init.headers['Authorization'] && !init.headers['authorization']){
              init.headers['Authorization'] = 'Bearer ' + token;
            }
          } catch (e) {}
          return origFetch(resource, init);
        };
        window._authWrapped = true;
      })();
    </script>
    <!-- LOGIN MODAL (exibe se não autenticado) -->
    <div
      id="loginModal"
      style="
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.5);
        z-index: 9999;
      "
    >
      <div
        style="
          background: #16213e;
          padding: 24px;
          border-radius: 8px;
          min-width: 320px;
          max-width: 420px;
          text-align: center;
        "
      >
        <h4>Entrar no Sistema</h4>
        <p>Faça login usando sua conta Google ou credenciais do administrador.</p>
        <div id="g_id_btn_container" style="margin: 12px 0"></div>
        <div style="margin-top: 8px">ou</div>
        <form id="adminLoginForm" style="margin-top: 8px">
          <input
            id="adminUser"
            name="username"
            placeholder="Usuário"
            required
            style="width: 100%; padding: 8px; margin-top: 8px; box-sizing: border-box"
          />
          <input
            id="adminPass"
            name="password"
            type="password"
            placeholder="Senha"
            required
            style="width: 100%; padding: 8px; margin-top: 8px; box-sizing: border-box"
          />
          <div id="loginError" style="display:none; margin-top:8px; color:#e74c3c; font-weight:600"></div>
          <button 
            id="loginBtn" 
            style="margin-top: 12px; padding: 8px 12px; width: 100%; cursor: pointer" 
            type="submit">Entrar</button>
        </form>
      </div>
    </div>
    <div class="container-fluid p-0">
      <!-- NAVBAR SUPERIOR -->
      <nav class="navbar navbar-dark py-2 px-3 border-bottom" style="background: var(--dark-sidebar); border-bottom: 1px solid rgba(52, 152, 219, 0.3) !important;">
        <div class="container-fluid">
          <div class="d-flex align-items-center">
            <img src="/imagens/logo-rcf.png" alt="RCF Logo" style="height: 50px; margin-right: 15px; object-fit: contain;" onerror="console.error('Logo não carregou'); this.style.display='none'">
            <div>
              <span class="navbar-brand mb-0 h1 fw-bold" style="color: #ffffff; margin: 0;">Refrigeração Campo Frio</span>
              <span class="navbar-text d-none d-sm-block ms-3" style="font-size: 11px; color: #ffffff !important;"
                >Created by Marciel</span
              >
            </div>
          </div>
          <div class="d-flex align-items-center">
            <span class="badge bg-success me-3" id="statusConexao">
              <i class="fas fa-wifi"></i> Online
            </span>

            <div class="user-info me-3 d-none d-md-flex">
              <div class="user-avatar" id="userAvatar">M</div>
              <div class="user-name" id="userNameDisplay">Administrador</div>
            </div>

            <a
              class="btn btn-outline-info btn-sm me-2"
              href="/email/connect/google"
              target="_blank"
              rel="noopener"
              title="Trocar conta Google"
            >
              <i class="fas fa-sync"></i> Google
            </a>

            <button
              class="btn btn-outline-secondary btn-sm me-2"
              onclick="limparCacheFront()"
              title="Limpar cache"
            >
              <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="logoutApp()" title="Sair">
              <i class="fas fa-sign-out-alt"></i> Sair
            </button>
          </div>
        </div>
      </nav>

      <!-- MENU LATERAL E CONTEÚDO -->
      <div class="d-flex">
        <!-- SIDEBAR -->
        <div class="sidebar bg-dark text-white">
          <div class="sidebar-sticky pt-3">
            <ul class="nav flex-column">
              <li class="nav-item">
                <a class="nav-link active" href="#" onclick="abrirAba('dashboard')">
                  <i class="fas fa-tachometer-alt me-2"></i> Dashboard
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" onclick="abrirAba('novoOrcamento')">
                  <i class="fas fa-file-invoice-dollar me-2"></i> Novo Orçamento
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" onclick="abrirAba('novaOS')">
                  <i class="fas fa-plus-circle me-2"></i> Nova OS Direta
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" onclick="abrirAba('orcamentos')">
                  <i class="fas fa-file-invoice me-2"></i> Orçamentos
                  <span class="badge bg-success float-end" id="badgeOrcamentos">0</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" onclick="abrirAba('ordens')">
                  <i class="fas fa-list me-2"></i> Ordens de Serviço
                  <span class="badge bg-danger float-end" id="badgeOrdens">0</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" onclick="abrirAba('estoque')">
                  <i class="fas fa-boxes me-2"></i> Estoque
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" onclick="abrirAba('clientes')">
                  <i class="fas fa-users me-2"></i> Clientes
                  <span class="badge bg-info float-end" id="badgeClientes">0</span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" onclick="abrirAba('relatorios')">
                  <i class="fas fa-chart-bar me-2"></i> Relatórios
                </a>
              </li>
              <li class="nav-item mt-4">
                <a class="nav-link text-warning" href="#" onclick="fazerBackup()">
                  <i class="fas fa-save me-2"></i> Backup
                </a>
              </li>
            </ul>
          </div>
        </div>

        <!-- CONTEÚDO PRINCIPAL -->
        <main class="main-content">
          <!-- DASHBOARD -->
          <div id="dashboard" class="aba-conteudo">
            <div class="row mb-4">
              <div class="col-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i> Dashboard</h5>
                    <div>
                      <button class="btn btn-sm btn-primary me-2" onclick="atualizarDashboard()">
                        <i class="fas fa-sync-alt"></i>
                      </button>
                      <small class="text-muted" id="dashboardTime"></small>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- CARDS RESUMO -->
                    <div class="row" id="dashboardCards">
                      <div class="col-12 text-center py-5">
                        <div class="loading" style="width: 40px; height: 40px"></div>
                        <p class="text-muted mt-2">Carregando dashboard...</p>
                      </div>
                    </div>

                    <!-- ALERTAS -->
                    <div class="row mt-4">
                      <div class="col-12">
                        <div class="card">
                          <div class="card-header">
                            <h6 class="mb-0">
                              <i class="fas fa-exclamation-triangle me-2 text-warning"></i> Alertas
                            </h6>
                          </div>
                          <div class="card-body p-0">
                            <div id="dashboardAlertas">
                              <div class="text-center py-4 text-muted">
                                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                                <p>Nenhum alerta no momento</p>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- GRÁFICOS -->
                    <div class="row mt-4">
                      <div class="col-md-6">
                        <div class="card">
                          <div class="card-header">
                            <h6 class="mb-0">
                              <i class="fas fa-chart-pie me-2"></i> Status das OS
                            </h6>
                          </div>
                          <div class="card-body">
                            <canvas id="graficoStatus" height="250"></canvas>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="card">
                          <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i> Performance</h6>
                          </div>
                          <div class="card-body">
                            <div id="performanceStats">
                              <p class="text-center py-4 text-muted">Carregando...</p>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- NOVO ORÇAMENTO -->
          <div id="novoOrcamento" class="aba-conteudo d-none">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                      <i class="fas fa-file-invoice-dollar me-2"></i> Novo Orçamento
                    </h5>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      onclick="abrirModalCriarOrcamentoExistente()"
                    >
                      <i class="fas fa-copy me-1"></i> Criar a partir de Orçamento Existente
                    </button>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <!-- CLIENTE -->
                      <div class="col-md-6">
                        <div class="card mb-4">
                          <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-user me-2"></i> Dados do Cliente</h6>
                          </div>
                          <div class="card-body">
                            <div class="mb-3">
                              <label class="form-label">Buscar Cliente Existente</label>
                              <div class="input-group">
                                <input
                                  type="text"
                                  class="form-control"
                                  id="buscarClienteOrcamento"
                                  placeholder="Digite nome ou telefone..."
                                  onkeyup="buscarClienteRapidoOrcamento(this.value)"
                                />
                                <button
                                  class="btn btn-outline-secondary"
                                  type="button"
                                  onclick="limparBuscaClienteOrcamento()"
                                >
                                  <i class="fas fa-times"></i>
                                </button>
                              </div>
                              <div id="resultadoBuscaClienteOrcamento" class="mt-2"></div>
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Nome *</label>
                              <input type="text" class="form-control" id="nomeOrcamento" required />
                            </div>

                            <div class="row">
                              <div class="col-md-8">
                                <div class="mb-3">
                                  <label class="form-label">Telefone *</label>
                                  <input
                                    type="tel"
                                    class="form-control"
                                    id="telefoneOrcamento"
                                    required
                                    oninput="formatarTelefone(this)"
                                  />
                                </div>
                              </div>
                              <div class="col-md-4">
                                <div class="mb-3">
                                  <label class="form-label">WhatsApp?</label>
                                  <select class="form-control" id="whatsappOrcamento">
                                    <option value="Sim">Sim</option>
                                    <option value="Não">Não</option>
                                  </select>
                                </div>
                              </div>
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Endereço *</label>
                              <input
                                type="text"
                                class="form-control"
                                id="enderecoOrcamento"
                                required
                              />
                            </div>

                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Cidade *</label>
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="cidadeOrcamento"
                                    required
                                  />
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Email *</label>
                                  <input
                                    type="email"
                                    class="form-control"
                                    id="emailOrcamento"
                                    required
                                  />
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- ORÇAMENTO -->
                      <div class="col-md-6">
                        <div class="card mb-4">
                          <div class="card-header bg-light">
                            <h6 class="mb-0">
                              <i class="fas fa-file-invoice-dollar me-2"></i> Detalhes do Orçamento
                            </h6>
                          </div>
                          <div class="card-body">
                            <div class="mb-3">
                              <label class="form-label">Data *</label>
                              <input type="date" class="form-control" id="dataOrcamento" required />
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Hora *</label>
                              <input type="time" class="form-control" id="horaOrcamento" required />
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Equipamento *</label>
                              <select class="form-control" id="equipamentoOrcamento" required>
                                <option value="">Selecione...</option>
                                <option value="Ar Condicionado">Ar Condicionado</option>
                                <option value="Geladeira">Geladeira</option>
                                <option value="Freezer">Freezer</option>
                                <option value="Câmara Frigorífica">Câmara Frigorífica</option>
                                <option value="Balcão Frigorífico">Balcão Frigorífico</option>
                                <option value="Outro">Outro</option>
                              </select>
                              <input
                                type="text"
                                class="form-control mt-2 d-none"
                                id="outroEquipamentoOrcamento"
                                placeholder="Especifique o equipamento..."
                              />
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Defeito Relatado *</label>
                              <textarea
                                class="form-control"
                                id="defeitoOrcamento"
                                rows="3"
                                required
                                placeholder="Descreva o problema..."
                              ></textarea>
                            </div>

                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Mão de Obra (R$) *</label>
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="maoObraOrcamento"
                                    step="0.01"
                                    min="0"
                                    value="0.00"
                                    oninput="atualizarTotalOrcamento()"
                                    required
                                  />
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Peças a substituir (rápido)</label>
                                  <div class="d-flex gap-2 flex-wrap align-items-center">
                                    <input type="text" class="form-control flex-grow-1" style="min-width: 120px" id="nomePecaRapida" placeholder="Nome" list="listaPecasEstoque" autocomplete="off" />
                                    <datalist id="listaPecasEstoque"></datalist>
                                    <input type="number" class="form-control" style="width: 80px" id="qtdPecaRapida" min="1" value="1" placeholder="Qtd" />
                                    <input type="number" class="form-control" style="width: 110px" id="valorPecaRapida" step="0.01" min="0" value="0.00" placeholder="Valor" />
                                    <button class="btn btn-outline-success" type="button" onclick="adicionarItemOrcamentoRapido()">
                                      <i class="fas fa-plus"></i>
                                    </button>
                                  </div>
                                  <small class="text-muted">Itens entram na lista de peças do orçamento.</small>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Validade (dias) *</label>
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="validadeOrcamento"
                                    value="7"
                                    min="1"
                                    required
                                  />
                                </div>
                              </div>
                            </div>

                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Técnico Responsável</label>
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="tecnicoOrcamento"
                                    placeholder="Nome do técnico..."
                                  />
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Garantia (dias) *</label>
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="garantiaOrcamento"
                                    value="90"
                                    min="0"
                                    required
                                  />
                                </div>
                              </div>
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Observações</label>
                              <textarea
                                class="form-control"
                                id="observacoesOrcamento"
                                rows="2"
                                placeholder="Observações adicionais..."
                              ></textarea>
                            </div>

                            <div class="mb-3">
                              <div class="form-check">
                                <input
                                  class="form-check-input"
                                  type="checkbox"
                                  id="enviarEmailOrcamento"
                                  checked
                                />
                                <label class="form-check-label" for="enviarEmailOrcamento">
                                  Enviar orçamento por email para o cliente
                                </label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="card mb-4">
                      <div class="card-header bg-light d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-cubes me-2"></i> Peças do Estoque e Totais</h6>
                        <button class="btn btn-sm btn-outline-secondary" onclick="carregarEstoque(true)">
                          <i class="fas fa-sync-alt"></i>
                        </button>
                      </div>
                      <div class="card-body">
                        <div class="row">
                          <div class="col-md-5">
                            <div class="mb-3">
                              <label class="form-label">Selecionar Peça do Estoque</label>
                              <select class="form-control" id="selectPecaOrcamento" onchange="mostrarDisponibilidadePeca()"></select>
                              <small class="text-muted" id="disponibilidadePeca"></small>
                            </div>
                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Quantidade</label>
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="quantidadePecaOrcamento"
                                    min="1"
                                    value="1"
                                  />
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Valor Unitário (R$)</label>
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="valorUnitarioPecaOrcamento"
                                    step="0.01"
                                    min="0"
                                    value="0.00"
                                  />
                                </div>
                              </div>
                            </div>
                            <button class="btn btn-outline-success w-100" onclick="adicionarItemOrcamento()">
                              <i class="fas fa-plus me-1"></i> Adicionar ao orçamento
                            </button>
                          </div>
                          <div class="col-md-7">
                            <div class="table-responsive">
                              <table class="table table-sm table-hover">
                                <thead class="table-success">
                                  <tr>
                                    <th>Peça</th>
                                    <th width="80">Qtd</th>
                                    <th width="120">Unitário</th>
                                    <th width="120">Subtotal</th>
                                    <th width="80">Ações</th>
                                  </tr>
                                </thead>
                                <tbody id="listaItensOrcamento">
                                  <tr>
                                    <td colspan="5" class="text-center py-3 text-muted">
                                      Nenhuma peça adicionada
                                    </td>
                                  </tr>
                                </tbody>
                              </table>
                            </div>

                            <div class="row mt-3">
                              <div class="col-md-6">
                                <div class="alert alert-card alert-info">
                                  Subtotal peças: <strong id="subtotalPecasValor">R$ 0,00</strong>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="alert alert-card alert-success">
                                  Total orçamento: <strong id="totalOrcamentoValor">R$ 0,00</strong>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- BOTÕES AÇÃO -->
                    <div class="row">
                      <div class="col-12">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                          <button
                            class="btn btn-secondary me-2"
                            onclick="limparFormularioOrcamento()"
                          >
                            <i class="fas fa-times me-1"></i> Limpar
                          </button>
                          <button
                            class="btn btn-success"
                            onclick="salvarOrcamentoFront()"
                            id="btnSalvarOrcamento"
                          >
                            <i class="fas fa-save me-1"></i> Salvar Orçamento
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- RESULTADO -->
                    <div id="resultadoOrcamento" class="mt-4"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- NOVA OS DIRETA -->
          <div id="novaOS" class="aba-conteudo d-none">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                      <i class="fas fa-plus-circle me-2"></i> Nova Ordem de Serviço (Direta)
                    </h5>
                    <button
                      class="btn btn-sm btn-outline-primary"
                      onclick="abrirModalCriarOSExistente()"
                    >
                      <i class="fas fa-copy me-1"></i> Criar a partir de OS Existente
                    </button>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <!-- CLIENTE -->
                      <div class="col-md-6">
                        <div class="card mb-4">
                          <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-user me-2"></i> Dados do Cliente</h6>
                          </div>
                          <div class="card-body">
                            <div class="mb-3">
                              <label class="form-label">Buscar Cliente Existente</label>
                              <div class="input-group">
                                <input
                                  type="text"
                                  class="form-control"
                                  id="buscarClienteOS"
                                  placeholder="Digite nome ou telefone..."
                                  onkeyup="buscarClienteRapidoOS(this.value)"
                                />
                                <button
                                  class="btn btn-outline-secondary"
                                  type="button"
                                  onclick="limparBuscaClienteOS()"
                                >
                                  <i class="fas fa-times"></i>
                                </button>
                              </div>
                              <div id="resultadoBuscaClienteOS" class="mt-2"></div>
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Nome *</label>
                              <input type="text" class="form-control" id="nomeOS" required />
                            </div>

                            <div class="row">
                              <div class="col-md-8">
                                <div class="mb-3">
                                  <label class="form-label">Telefone *</label>
                                  <input
                                    type="tel"
                                    class="form-control"
                                    id="telefoneOS"
                                    required
                                    oninput="formatarTelefone(this)"
                                  />
                                </div>
                              </div>
                              <div class="col-md-4">
                                <div class="mb-3">
                                  <label class="form-label">WhatsApp?</label>
                                  <select class="form-control" id="whatsappOS">
                                    <option value="Sim">Sim</option>
                                    <option value="Não">Não</option>
                                  </select>
                                </div>
                              </div>
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Endereço *</label>
                              <input type="text" class="form-control" id="enderecoOS" required />
                            </div>

                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Cidade *</label>
                                  <input type="text" class="form-control" id="cidadeOS" required />
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Email</label>
                                  <input type="email" class="form-control" id="emailOS" />
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- SERVIÇO -->
                      <div class="col-md-6">
                        <div class="card mb-4">
                          <div class="card-header bg-light">
                            <h6 class="mb-0">
                              <i class="fas fa-tools me-2"></i> Detalhes do Serviço
                            </h6>
                          </div>
                          <div class="card-body">
                            <div class="mb-3">
                              <label class="form-label">Data *</label>
                              <input type="date" class="form-control" id="dataOS" required />
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Hora *</label>
                              <input type="time" class="form-control" id="horaOS" required />
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Equipamento *</label>
                              <select class="form-control" id="equipamentoOS" required>
                                <option value="">Selecione...</option>
                                <option value="Ar Condicionado">Ar Condicionado</option>
                                <option value="Geladeira">Geladeira</option>
                                <option value="Freezer">Freezer</option>
                                <option value="Câmara Frigorífica">Câmara Frigorífica</option>
                                <option value="Balcão Frigorífico">Balcão Frigorífico</option>
                                <option value="Outro">Outro</option>
                              </select>
                              <input
                                type="text"
                                class="form-control mt-2 d-none"
                                id="outroEquipamentoOS"
                                placeholder="Especifique o equipamento..."
                              />
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Defeito Relatado *</label>
                              <textarea
                                class="form-control"
                                id="defeitoOS"
                                rows="3"
                                required
                                placeholder="Descreva o problema..."
                              ></textarea>
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Status</label>
                              <select class="form-control" id="statusOS">
                                <option value="Aberto" selected>Aberto</option>
                                <option value="Em Andamento">Em Andamento</option>
                              </select>
                            </div>

                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Valor Estimado (R$)</label>
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="valorOS"
                                    step="0.01"
                                    value="0.00"
                                  />
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Prazo</label>
                                  <input type="date" class="form-control" id="prazoOS" />
                                </div>
                              </div>
                            </div>

                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Técnico Responsável</label>
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="tecnicoOS"
                                    placeholder="Nome do técnico..."
                                  />
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Garantia (dias)</label>
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="garantiaOS"
                                    value="90"
                                    min="0"
                                  />
                                </div>
                              </div>
                            </div>

                            <div class="mb-3">
                              <label class="form-label">Observações</label>
                              <textarea
                                class="form-control"
                                id="observacoesOS"
                                rows="2"
                                placeholder="Observações adicionais..."
                              ></textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- BOTÕES AÇÃO -->
                    <div class="row">
                      <div class="col-12">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                          <button class="btn btn-secondary me-2" onclick="limparFormularioOS()">
                            <i class="fas fa-times me-1"></i> Limpar
                          </button>
                          <button
                            class="btn btn-primary"
                            onclick="salvarOSFront()"
                            id="btnSalvarOS"
                          >
                            <i class="fas fa-save me-1"></i> Salvar Ordem
                          </button>
                        </div>
                      </div>
                    </div>

                    <!-- RESULTADO -->
                    <div id="resultadoOS" class="mt-4"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ORÇAMENTOS -->
          <div id="orcamentos" class="aba-conteudo d-none">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-file-invoice me-2"></i> Orçamentos</h5>
                    <div>
                      <button
                        class="btn btn-sm btn-outline-secondary me-2"
                        onclick="exportarOrcamentos()"
                      >
                        <i class="fas fa-download"></i> Exportar
                      </button>
                      <button class="btn btn-sm btn-success" onclick="carregarOrcamentos(true)">
                        <i class="fas fa-sync-alt"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- FILTROS -->
                    <div class="row mb-4">
                      <div class="col-md-4">
                        <div class="search-box">
                          <i class="fas fa-search"></i>
                          <input
                            type="text"
                            class="form-control"
                            id="filtroBuscaOrcamento"
                            placeholder="Buscar protocolo, cliente, equipamento..."
                            onkeyup="filtrarOrcamentosRapido()"
                          />
                        </div>
                      </div>
                      <div class="col-md-3">
                        <select
                          class="form-control"
                          id="filtroStatusOrcamento"
                          onchange="filtrarOrcamentosRapido()"
                        >
                          <option value="">Todos status</option>
                          <option value="Orçamento">Orçamento</option>
                          <option value="Aprovado">Aprovado</option>
                          <option value="Cancelado">Cancelado</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <select
                          class="form-control"
                          id="filtroMesOrcamento"
                          onchange="filtrarOrcamentosRapido()"
                        >
                          <option value="">Todos meses</option>
                          <option value="01">Janeiro</option>
                          <option value="02">Fevereiro</option>
                          <option value="03">Março</option>
                          <option value="04">Abril</option>
                          <option value="05">Maio</option>
                          <option value="06">Junho</option>
                          <option value="07">Julho</option>
                          <option value="08">Agosto</option>
                          <option value="09">Setembro</option>
                          <option value="10">Outubro</option>
                          <option value="11">Novembro</option>
                          <option value="12">Dezembro</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <button
                          class="btn btn-outline-danger w-100"
                          onclick="limparFiltrosOrcamentos()"
                        >
                          <i class="fas fa-times"></i> Limpar
                        </button>
                      </div>
                    </div>

                    <!-- TABELA -->
                    <div class="table-responsive">
                      <table class="table table-hover table-sm">
                        <thead class="table-success">
                          <tr>
                            <th width="120">Protocolo</th>
                            <th width="100">Data</th>
                            <th>Cliente</th>
                            <th>Equipamento</th>
                            <th width="120">Status</th>
                            <th width="100">Valor</th>
                            <th width="150">Ações</th>
                          </tr>
                        </thead>
                        <tbody id="tabelaOrcamentos">
                          <tr>
                            <td colspan="7" class="text-center py-5">
                              <div
                                class="loading"
                                style="width: 30px; height: 30px; margin: 0 auto"
                              ></div>
                              <p class="text-muted mt-2">Carregando orçamentos...</p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <!-- PAGINAÇÃO -->
                    <div class="row mt-3">
                      <div class="col-12">
                        <nav id="paginacaoOrcamentos">
                          <!-- Paginação será gerada aqui -->
                        </nav>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ORDENS DE SERVIÇO -->
          <div id="ordens" class="aba-conteudo d-none">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i> Ordens de Serviço</h5>
                    <div>
                      <button
                        class="btn btn-sm btn-outline-secondary me-2"
                        onclick="exportarOrdens()"
                      >
                        <i class="fas fa-download"></i> Exportar
                      </button>
                      <button class="btn btn-sm btn-primary" onclick="carregarOrdens(true)">
                        <i class="fas fa-sync-alt"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <!-- FILTROS -->
                    <div class="row mb-4">
                      <div class="col-md-4">
                        <div class="search-box">
                          <i class="fas fa-search"></i>
                          <input
                            type="text"
                            class="form-control"
                            id="filtroBuscaOS"
                            placeholder="Buscar protocolo, cliente, equipamento..."
                            onkeyup="filtrarOrdensRapido()"
                          />
                        </div>
                      </div>
                      <div class="col-md-3">
                        <select
                          class="form-control"
                          id="filtroStatusOS"
                          onchange="filtrarOrdensRapido()"
                        >
                          <option value="">Todos status</option>
                          <option value="Aberto">Aberto</option>
                          <option value="Em Andamento">Em Andamento</option>
                          <option value="Concluído">Concluído</option>
                          <option value="Pago">Pago</option>
                          <option value="Cancelado">Cancelado</option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <select
                          class="form-control"
                          id="filtroMesOS"
                          onchange="filtrarOrdensRapido()"
                        >
                          <option value="">Todos meses</option>
                          <option value="01">Janeiro</option>
                          <option value="02">Fevereiro</option>
                          <option value="03">Março</option>
                          <option value="04">Abril</option>
                          <option value="05">Maio</option>
                          <option value="06">Junho</option>
                          <option value="07">Julho</option>
                          <option value="08">Agosto</option>
                          <option value="09">Setembro</option>
                          <option value="10">Outubro</option>
                          <option value="11">Novembro</option>
                          <option value="12">Dezembro</option>
                        </select>
                      </div>
                      <div class="col-md-2">
                        <button class="btn btn-outline-danger w-100" onclick="limparFiltrosOS()">
                          <i class="fas fa-times"></i> Limpar
                        </button>
                      </div>
                    </div>

                    <!-- TABELA -->
                    <div class="table-responsive">
                      <table class="table table-hover table-sm">
                        <thead class="table-dark">
                          <tr>
                            <th width="120">Protocolo</th>
                            <th width="100">Data</th>
                            <th>Cliente</th>
                            <th>Equipamento</th>
                            <th width="120">Status</th>
                            <th width="100">Valor</th>
                            <th width="150">Ações</th>
                          </tr>
                        </thead>
                        <tbody id="tabelaOrdens">
                          <tr>
                            <td colspan="7" class="text-center py-5">
                              <div
                                class="loading"
                                style="width: 30px; height: 30px; margin: 0 auto"
                              ></div>
                              <p class="text-muted mt-2">Carregando ordens...</p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>

                    <!-- PAGINAÇÃO -->
                    <div class="row mt-3">
                      <div class="col-12">
                        <nav id="paginacaoOrdens">
                          <!-- Paginação será gerada aqui -->
                        </nav>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- ESTOQUE -->
          <div id="estoque" class="aba-conteudo d-none">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-boxes me-2"></i> Estoque</h5>
                    <div>
                      <button class="btn btn-sm btn-primary" onclick="carregarEstoque(true)">
                        <i class="fas fa-sync-alt"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="row">
                      <div class="col-md-4">
                        <div class="card mb-3">
                          <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-plus me-2"></i> Adicionar/Atualizar Peça</h6>
                          </div>
                          <div class="card-body">
                            <div class="mb-3">
                              <label class="form-label">Nome da Peça</label>
                              <input type="text" class="form-control" id="novaPecaNome" placeholder="Ex: Condensador" />
                            </div>
                            <div class="mb-3">
                              <label class="form-label">Quantidade</label>
                              <input type="number" class="form-control" id="novaPecaQuantidade" min="1" value="1" />
                            </div>
                            <button class="btn btn-success w-100" onclick="adicionarPecaEstoque()">
                              <i class="fas fa-save me-1"></i> Salvar no Estoque
                            </button>
                          </div>
                        </div>

                        <div class="card">
                          <div class="card-header bg-light">
                            <h6 class="mb-0"><i class="fas fa-exchange-alt me-2"></i> Movimentação</h6>
                          </div>
                          <div class="card-body">
                            <div class="mb-3">
                              <label class="form-label">Peça</label>
                              <select class="form-control" id="selectMovimentacaoPeca"></select>
                            </div>
                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Tipo</label>
                                  <select class="form-control" id="tipoMovimentacao">
                                    <option value="entrada">Entrada</option>
                                    <option value="saida">Saída</option>
                                  </select>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label class="form-label">Quantidade</label>
                                  <input type="number" class="form-control" id="quantidadeMovimentacao" min="1" value="1" />
                                </div>
                              </div>
                            </div>
                            <button class="btn btn-outline-primary w-100" onclick="registrarMovimentacaoEstoque()">
                              <i class="fas fa-check me-1"></i> Registrar
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="col-md-8">
                        <div class="table-responsive">
                          <table class="table table-hover table-sm">
                            <thead class="table-dark">
                              <tr>
                                <th>Peça</th>
                                <th width="120">Em estoque</th>
                              </tr>
                            </thead>
                            <tbody id="tabelaEstoque">
                              <tr>
                                <td colspan="2" class="text-center py-4">
                                  <div class="loading" style="width: 30px; height: 30px; margin: 0 auto"></div>
                                  <p class="text-muted mt-2">Carregando estoque...</p>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- CLIENTES -->
          <div id="clientes" class="aba-conteudo d-none">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-users me-2"></i> Clientes</h5>
                    <button class="btn btn-sm btn-primary" onclick="carregarClientes(true)">
                      <i class="fas fa-sync-alt"></i>
                    </button>
                  </div>
                  <div class="card-body">
                    <!-- FILTRO CLIENTES -->
                    <div class="row mb-4">
                      <div class="col-md-6">
                        <div class="search-box">
                          <i class="fas fa-search"></i>
                          <input
                            type="text"
                            class="form-control"
                            id="filtroCliente"
                            placeholder="Buscar cliente por nome, telefone, cidade..."
                            onkeyup="filtrarClientesRapido()"
                          />
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-check form-switch">
                          <input
                            class="form-check-input"
                            type="checkbox"
                            id="filtroAtivos"
                            checked
                            onchange="filtrarClientesRapido()"
                          />
                          <label class="form-check-label" for="filtroAtivos"
                            >Mostrar apenas clientes com OS</label
                          >
                        </div>
                      </div>
                    </div>

                    <!-- TABELA CLIENTES -->
                    <div class="table-responsive">
                      <table class="table table-hover">
                        <thead class="table-primary">
                          <tr>
                            <th>Nome</th>
                            <th>Telefone</th>
                            <th>Cidade</th>
                            <th>Total OS</th>
                            <th>Última OS</th>
                            <th>Ações</th>
                          </tr>
                        </thead>
                        <tbody id="tabelaClientes">
                          <tr>
                            <td colspan="6" class="text-center py-5">
                              <div
                                class="loading"
                                style="width: 30px; height: 30px; margin: 0 auto"
                              ></div>
                              <p class="text-muted mt-2">Carregando clientes...</p>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- RELATÓRIOS -->
          <div id="relatorios" class="aba-conteudo d-none">
            <div class="row">
              <div class="col-12">
                <div class="card">
                  <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i> Relatórios</h5>
                  </div>
                  <div class="card-body">
                    <div class="row mb-4">
                      <div class="col-md-4">
                        <div class="card">
                          <div class="card-body text-center">
                            <h6>Relatório Mensal</h6>
                            <div class="row mt-3">
                              <div class="col-6">
                                <select class="form-control" id="relatorioMes">
                                  <option value="01">Janeiro</option>
                                  <option value="02">Fevereiro</option>
                                  <option value="03">Março</option>
                                  <option value="04">Abril</option>
                                  <option value="05">Maio</option>
                                  <option value="06">Junho</option>
                                  <option value="07">Julho</option>
                                  <option value="08">Agosto</option>
                                  <option value="09">Setembro</option>
                                  <option value="10">Outubro</option>
                                  <option value="11">Novembro</option>
                                  <option value="12">Dezembro</option>
                                </select>
                              </div>
                              <div class="col-6">
                                <select class="form-control" id="relatorioAno">
                                  <!-- Anos serão preenchidos dinamicamente pelo JavaScript -->
                                </select>
                              </div>
                            </div>
                            <button
                              class="btn btn-primary mt-3 w-100"
                              onclick="gerarRelatorioMensal()"
                            >
                              <i class="fas fa-chart-pie me-1"></i> Gerar Relatório
                            </button>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-4">
                        <div class="card">
                          <div class="card-body text-center">
                            <h6>Relatório Financeiro</h6>
                            <p class="text-muted small mt-2">Análise de valores por período</p>
                            <div class="row mt-3">
                              <div class="col-6">
                                <input
                                  type="month"
                                  class="form-control"
                                  id="periodoInicio"
                                  value="2025-01"
                                />
                              </div>
                              <div class="col-6">
                                <input
                                  type="month"
                                  class="form-control"
                                  id="periodoFim"
                                  value="2025-12"
                                />
                              </div>
                            </div>
                            <button
                              class="btn btn-success mt-3 w-100"
                              onclick="gerarRelatorioFinanceiro()"
                            >
                              <i class="fas fa-money-bill-wave me-1"></i> Gerar Financeiro
                            </button>
                          </div>
                        </div>
                      </div>

                      <div class="col-md-4">
                        <div class="card">
                          <div class="card-body text-center">
                            <h6>Exportar Dados</h6>
                            <p class="text-muted small mt-2">Exportar todos os dados do sistema</p>
                            <div class="d-grid gap-2 mt-2">
                              <button class="btn btn-info" onclick="exportarParaCSV()">
                                <i class="fas fa-file-csv me-1"></i> CSV
                              </button>
                              <button class="btn btn-warning" onclick="exportarParaExcel()">
                                <i class="fas fa-file-excel me-1"></i> Excel
                              </button>
                              <button class="btn btn-secondary" onclick="exportarParaPDF()">
                                <i class="fas fa-file-pdf me-1"></i> PDF
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- RESULTADO RELATÓRIOS -->
                    <div id="resultadoRelatorios"></div>

                    <!-- GRÁFICO RELATÓRIO -->
                    <div class="card mt-4">
                      <div class="card-header">
                        <h6 class="mb-0">Visualização Gráfica</h6>
                      </div>
                      <div class="card-body">
                        <canvas id="graficoRelatorio" height="300"></canvas>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>

      <!-- MODAL DETALHES ORÇAMENTO/OS -->
      <div class="modal fade" id="modalDetalhes" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-success text-white">
              <h5 class="modal-title">Detalhes</h5>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body" id="modalDetalhesBody">Carregando...</div>
          </div>
        </div>
      </div>

      <!-- MODAL APROVAR/CANCELAR ORÇAMENTO -->
      <div class="modal fade" id="modalAcaoOrcamento" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalAcaoOrcamentoTitle">Ação do Orçamento</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Deseja enviar email para o cliente?</label>
                <select class="form-control" id="enviarEmailAcao">
                  <option value="sim">Sim, enviar email</option>
                  <option value="nao">Não, apenas atualizar status</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Observações (serão incluídas no email):</label>
                <textarea
                  class="form-control"
                  id="observacoesAcao"
                  rows="3"
                  placeholder="Observações adicionais..."
                ></textarea>
              </div>
              <input type="hidden" id="protocoloOrcamentoAcao" />
              <input type="hidden" id="tipoAcaoOrcamento" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
              <button type="button" class="btn btn-primary" onclick="confirmarAcaoOrcamento()">
                Confirmar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL ALTERAR STATUS OS -->
      <div class="modal fade" id="modalAlterarStatusOS" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Alterar Status da OS</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Novo Status</label>
                <select class="form-control" id="novoStatusOS">
                  <option value="Aberto">Aberto</option>
                  <option value="Em Andamento">Em Andamento</option>
                  <option value="Concluído">Concluído</option>
                  <option value="Pago">Pago</option>
                  <option value="Cancelado">Cancelado</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Deseja enviar email para o cliente?</label>
                <select class="form-control" id="enviarEmailStatusOS">
                  <option value="sim">Sim, enviar email</option>
                  <option value="nao">Não, apenas atualizar status</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Observações (serão incluídas no email):</label>
                <textarea
                  class="form-control"
                  id="observacoesStatusOS"
                  rows="3"
                  placeholder="Observações adicionais..."
                ></textarea>
              </div>
              <input type="hidden" id="protocoloOSStatus" />
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
              <button type="button" class="btn btn-primary" onclick="confirmarAlterarStatusOS()">
                Confirmar
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL CRIAR A PARTIR DE ORÇAMENTO EXISTENTE -->
      <div class="modal fade" id="modalCriarOrcamentoExistente" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Criar a partir de Orçamento Existente</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Digite o Protocolo do Orçamento</label>
                <input
                  type="text"
                  class="form-control"
                  id="inputProtocoloOrcamentoCopia"
                  placeholder="Ex: OC230512ABC123"
                />
              </div>
              <div id="infoProtocoloOrcamentoCopia"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="criarOrcamentoAPartirDeProtocoloConfirmar()"
              >
                Criar Novo Orçamento
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- MODAL CRIAR A PARTIR DE OS EXISTENTE -->
      <div class="modal fade" id="modalCriarOSExistente" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Criar a partir de OS Existente</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="mb-3">
                <label class="form-label">Digite o Protocolo da OS</label>
                <input
                  type="text"
                  class="form-control"
                  id="inputProtocoloOSCopia"
                  placeholder="Ex: OS230512ABC123"
                />
              </div>
              <div id="infoProtocoloOSCopia"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                Cancelar
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="criarOSAPartirDeProtocoloConfirmar()"
              >
                Criar Nova OS
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- TOAST NOTIFICAÇÕES -->
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        <div id="toastContainer" class="toast-container"></div>
      </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        // Captura erros globais para evitar travar a página e mostrar no console/toast
        window.addEventListener('error', function(event) {
          try {
            console.error('Erro global:', event.message, event.filename, event.lineno, event.colno, event.error);
            if (typeof mostrarToast === 'function') {
              mostrarToast('Erro: ' + event.message, 'danger');
            }
          } catch (e) {}
        });

        window.addEventListener('unhandledrejection', function(event) {
          try {
            console.error('Promise não tratada:', event.reason);
            if (typeof mostrarToast === 'function') {
              mostrarToast('Erro: ' + (event.reason && event.reason.message ? event.reason.message : event.reason), 'danger');
            }
          } catch (e) {}
        });

        // Esconde o modal se já estiver autenticado
        (function(){
          try {
            const token = localStorage.getItem('token');
            if (token) {
              const modal = document.getElementById('loginModal');
              if (modal) modal.style.display = 'none';
            }
          } catch(e) {}
        })();

        // Espera um pouco para garantir que o DOM está pronto
        setTimeout(() => {
          console.log('🚀 Iniciando setup de login');
          
          const form = document.getElementById('adminLoginForm');
          
          if (!form) {
            console.error('❌ Formulário não encontrado');
            return;
          }
          
          console.log('✅ Formulário encontrado');
          
          let isSubmitting = false;
          
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('📝 Submit disparado');
            
            if (isSubmitting) return;
            isSubmitting = true;
            
            const username = document.getElementById('adminUser').value;
            const password = document.getElementById('adminPass').value;
            const btn = form.querySelector('button');
            const errBox = document.getElementById('loginError');
            if (errBox) { errBox.style.display = 'none'; errBox.textContent = ''; }
            
            btn.disabled = true;
            btn.textContent = 'Autenticando...';
            
            try {
              console.log('📤 Enviando POST /auth/login');
              const res = await fetch('/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
              });
              
              const data = await res.json();
              
              if (!res.ok) {
                const msg = data.error || 'Erro ao fazer login';
                if (errBox) { errBox.textContent = msg; errBox.style.display = 'block'; }
                setTimeout(() => {
                  btn.disabled = false;
                  btn.textContent = 'Entrar';
                  isSubmitting = false;
                }, 1500);
                return;
              }
              
              console.log('✅ Login sucesso');
              localStorage.setItem('token', data.token);
              document.getElementById('loginModal').style.display = 'none';
              window.location.reload();
            } catch (err) {
              console.error('❌ Erro:', err);
              if (errBox) { errBox.textContent = 'Erro: ' + err.message; errBox.style.display = 'block'; }
              setTimeout(() => {
                btn.disabled = false;
                btn.textContent = 'Entrar';
                isSubmitting = false;
              }, 1500);
            }
          });
          
          console.log('✅ Setup completo');
        }, 100);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script>

        // Helper to prompt for password for sensitive actions
        window.promptPassword = function(promptText){
          return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.style = 'position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.5);z-index:99999;';
            modal.innerHTML = `<div style="background:white;padding:18px;border-radius:8px;min-width:280px;text-align:center;">
              <h6>${promptText||'Confirme sua senha'}</h6>
              <input id="__pw_input" type="password" style="width:100%;padding:8px;margin-top:8px" />
              <div style="margin-top:12px"><button id="__pw_ok">OK</button> <button id="__pw_cancel">Cancelar</button></div>
            </div>`;
            document.body.appendChild(modal);
            document.getElementById('__pw_ok').onclick = ()=>{ const v = document.getElementById('__pw_input').value; document.body.removeChild(modal); resolve(v); };
            document.getElementById('__pw_cancel').onclick = ()=>{ document.body.removeChild(modal); resolve(null); };
          });
        };
      // ========== VARIÁVEIS GLOBAIS ==========
      let todasOrdensCache = [];
      let todasOrdensFiltradas = [];
      let todosOrcamentosCache = [];
      let todosOrcamentosFiltrados = [];
      let todosClientesCache = [];
      let dashboardDataCache = null;
      let paginaAtualOrdens = 1;
      let paginaAtualOrcamentos = 1;
      const itensPorPagina = 20;
      let graficoStatus = null;
      let graficoRelatorio = null;
      let estoqueCache = [];
      let itensOrcamentoSelecionados = [];

      // ========== CACHE FRONTEND AVANÇADO ==========
      let frontendCache = {
        ordens: null,
        orcamentos: null,
        clientes: null,
        dashboard: null,
        timestamp: null,

        get: function(key) {
          const item = this[key];
          if (item && item.timestamp && (Date.now() - item.timestamp) < 300000) {
            return item.data;
          }
          return null;
        },

        set: function(key, data) {
          this[key] = {
            data: data,
            timestamp: Date.now()
          };
        },

        clear: function() {
          this.ordens = null;
          this.orcamentos = null;
          this.clientes = null;
          this.dashboard = null;
          this.timestamp = null;
        }
      };

      // ========== SISTEMA DE FAVORITOS ==========
      let favoritosManager = null;

      function setupFavoritos() {
        let favoritos = JSON.parse(localStorage.getItem('os_favoritos') || '[]');

        return {
          adicionar: function(protocolo) {
            if (!favoritos.includes(protocolo)) {
              favoritos.push(protocolo);
              localStorage.setItem('os_favoritos', JSON.stringify(favoritos));
              mostrarToast('OS adicionada aos favoritos', 'success');
            }
          },

          remover: function(protocolo) {
            favoritos = favoritos.filter(f => f !== protocolo);
            localStorage.setItem('os_favoritos', JSON.stringify(favoritos));
              mostrarToast('OS removida dos favoritos', 'info');
          },

          listar: function() {
            return favoritos;
          },

          tem: function(protocolo) {
            return favoritos.includes(protocolo);
          }
        };
      }

      // ========== VERIFICAÇÃO DE SETUP ==========
      async function checkEmailSetup() {
        // Não verificar se já voltando de setup completo
        if (window.location.search.includes('setup_complete=1')) {
          window.history.replaceState({}, document.title, window.location.pathname);
          showNotification('✅ Email configurado com sucesso!', 'success');
          return;
        }

        try {
          const response = await fetch('/email/status');
          if (!response.ok) throw new Error('Erro ao verificar status');
          const data = await response.json();
          
          // Se não está configurado, redireciona para setup
          if (!data.configured) {
            console.log('⚠️ Email não configurado, redirecionando para setup');
            window.location.href = '/setup.html';
          } else {
            console.log('✅ Email configurado para:', data.email);
            mostrarToast('Email configurado com sucesso!', 'success');
          }
        } catch (error) {
          console.error('Erro ao verificar configuração de email:', error);
          // Se houver erro, permite continuar (pode não estar crítico)
        }
      }

      // ========== INICIALIZAÇÃO ==========
      document.addEventListener('DOMContentLoaded', function() {
        console.log('🚀 Sistema OS iniciado - v${CONFIG.version}');

        // Exibir nome do usuário logado
        try {
          const token = localStorage.getItem('token');
          if (token) {
            const payload = JSON.parse(atob(token.split('.')[1]));
            const displayName = payload.name || payload.email || payload.username || 'Administrador';
            document.getElementById('userNameDisplay').textContent = displayName;
            const avatar = document.getElementById('userAvatar');
            if (avatar && displayName) {
              avatar.textContent = displayName.trim().charAt(0).toUpperCase();
            }
          }
        } catch(e) {
          console.error('Erro ao decodificar token:', e);
        }

        // Verificar se precisa fazer setup de email na primeira vez
        checkEmailSetup();

        window.onbeforeunload = null;

        configurarDataHora();

        carregarDashboard();
        carregarOrcamentos();
        carregarOrdens();
        carregarClientes();
        carregarEstoque();

        configurarEventos();

        // Event listeners para autocomplete de peças
        const nomePecaInput = document.getElementById('nomePecaRapida');
        if (nomePecaInput) {
          nomePecaInput.addEventListener('input', (e) => {
            buscarPecasEstoque(e.target.value);
          });
          nomePecaInput.addEventListener('change', preencherValorPecaSelecionada);
        }

        iniciarAtualizacaoAutomatica();

        // INICIALIZAR SISTEMAS AVANÇADOS
        favoritosManager = setupFavoritos();
        setupAtalhosTeclado();
        setupScrollSuave();
        requestNotificationPermission();

        // CHAMADA ADICIONADA AQUI 👇
        popularAnosRelatorio(); // <- ADICIONE ESTA LINHA

        // Inicia sincronização automática após 30 segundos
        setTimeout(() => {
          const autoSync = setupAutoSync();
          autoSync.start(120000);
        }, 30000);

        mostrarToast('Sistema carregado com sucesso!', 'success');
      });

      function configurarDataHora() {
        const hoje = new Date();
        document.getElementById('dataOrcamento').value = hoje.toISOString().split('T')[0];
        document.getElementById('horaOrcamento').value = hoje.getHours().toString().padStart(2, '0') + ':' + hoje.getMinutes().toString().padStart(2, '0');
        document.getElementById('dataOS').value = hoje.toISOString().split('T')[0];
        document.getElementById('horaOS').value = hoje.getHours().toString().padStart(2, '0') + ':' + hoje.getMinutes().toString().padStart(2, '0');

        const prazo = new Date();
        prazo.setDate(prazo.getDate() + 7);
        document.getElementById('prazoOS').value = prazo.toISOString().split('T')[0];

        // Configurar mês e ano atual nos relatórios
        const mesAtual = (hoje.getMonth() + 1).toString().padStart(2, '0');
        document.getElementById('relatorioMes').value = mesAtual;

        // Configurar os selects de período financeiro
        const anoAtual = hoje.getFullYear();
        const mesString = hoje.getMonth() + 1 < 10 ? '0' + (hoje.getMonth() + 1) : hoje.getMonth() + 1;
        document.getElementById('periodoInicio').value = anoAtual + '-' + mesString;
        document.getElementById('periodoFim').value = anoAtual + '-' + mesString;

        // Configurar anos disponíveis no relatório
        configurarAnoRelatorio();
      }

      function configurarAnoRelatorio() {
        const anoSelect = document.getElementById('relatorioAno');
        if (!anoSelect) return;

        const anoAtual = new Date().getFullYear();
        const anoSelecionado = anoSelect.value;

        // Limpar opções existentes
        anoSelect.innerHTML = '';

        // Adicionar opções dos últimos 10 anos
        for (let ano = anoAtual; ano >= anoAtual - 10; ano--) {
          const option = document.createElement('option');
          option.value = ano;
          option.textContent = ano;
          if (ano == anoSelecionado || (ano == anoAtual && !anoSelecionado)) {
            option.selected = true;
          }
          anoSelect.appendChild(option);
        }
      }

      function configurarEventos() {
        // Eventos para formulário de orçamento
        document.getElementById('equipamentoOrcamento').addEventListener('change', function() {
          const outroInput = document.getElementById('outroEquipamentoOrcamento');
          outroInput.classList.toggle('d-none', this.value !== 'Outro');
          if (this.value !== 'Outro') outroInput.value = '';
        });

        document.getElementById('telefoneOrcamento').addEventListener('blur', function() {
          formatarTelefone(this);
          buscarClientePorTelefoneOrcamento(this.value);
        });

        // Eventos para formulário de OS
        document.getElementById('equipamentoOS').addEventListener('change', function() {
          const outroInput = document.getElementById('outroEquipamentoOS');
          outroInput.classList.toggle('d-none', this.value !== 'Outro');
          if (this.value !== 'Outro') outroInput.value = '';
        });

        document.getElementById('telefoneOS').addEventListener('blur', function() {
          formatarTelefone(this);
          buscarClientePorTelefoneOS(this.value);
        });

        document.getElementById('maoObraOrcamento')?.addEventListener('input', atualizarTotalOrcamento);

        // Eventos para modais
        document.getElementById('inputProtocoloOrcamentoCopia')?.addEventListener('input', function() {
          buscarOrcamentoParaCopia(this.value);
        });

        document.getElementById('inputProtocoloOSCopia')?.addEventListener('input', function() {
          buscarOSParaCopia(this.value);
        });
      }
      // ========== FUNÇÃO PARA GERAR ANOS DINÂMICOS ==========
      function popularAnosRelatorio() {
        const selectAno = document.getElementById('relatorioAno');
        if (!selectAno) return;

        const anoAtual = new Date().getFullYear();
        const anoInicial = anoAtual - 10; // Mostra até 10 anos atrás

        selectAno.innerHTML = '';

        // Adiciona opções do ano atual até o ano inicial
        for (let ano = anoAtual; ano >= anoInicial; ano--) {
          const option = document.createElement('option');
          option.value = ano;
          option.textContent = ano;
          if (ano === anoAtual) {
            option.selected = true; // Seleciona o ano atual por padrão
          }
          selectAno.appendChild(option);
        }
      }

      // ========== NAVEGAÇÃO ==========
      function abrirAba(aba, event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }

        document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.aba-conteudo').forEach(el => el.classList.add('d-none'));

        const linkAtivo = document.querySelector(`a[onclick*="${aba}"]`);
        if (linkAtivo) linkAtivo.classList.add('active');

        const abaElement = document.getElementById(aba);
        if (abaElement) {
          abaElement.classList.remove('d-none');
          window.scrollTo({top: 0, behavior: 'smooth'});
        }

        // Carregar dados específicos da aba
        if (aba === 'orcamentos') {
          carregarOrcamentos();
        } else if (aba === 'ordens') {
          carregarOrdens();
        } else if (aba === 'clientes') {
          carregarClientes();
        } else if (aba === 'estoque' || aba === 'novoOrcamento') {
          carregarEstoque();
          if (aba === 'novoOrcamento') {
            atualizarTotalOrcamento();
          }
        }

        return false;
      }

      // ========== ESTOQUE ==========
      async function carregarEstoque(force = false) {
        const tbody = document.getElementById('tabelaEstoque');

        if (!force && estoqueCache && estoqueCache.length) {
          renderizarTabelaEstoque();
          popularSelectEstoque();
          return;
        }

        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="2" class="text-center py-4"><div class="loading" style="width: 30px; height: 30px; margin: 0 auto"></div><p class="text-muted mt-2">Carregando estoque...</p></td></tr>';
        }

        try {
          const res = await fetch('/estoque');
          if (!res.ok) throw new Error('Erro ao carregar estoque');
          const data = await res.json();
          estoqueCache = Array.isArray(data) ? data : [];
          renderizarTabelaEstoque();
          popularSelectEstoque();
        } catch (err) {
          console.error('Erro estoque:', err);
          if (tbody) {
            tbody.innerHTML = '<tr><td colspan="2" class="text-center text-danger py-4">Erro ao carregar estoque</td></tr>';
          }
          mostrarToast('Erro ao carregar estoque', 'danger');
        }
      }

      function renderizarTabelaEstoque() {
        const tbody = document.getElementById('tabelaEstoque');
        if (!tbody) return;

        if (!estoqueCache || estoqueCache.length === 0) {
          tbody.innerHTML = '<tr><td colspan="2" class="text-center py-4 text-muted">Nenhuma peça cadastrada</td></tr>';
          return;
        }

        let html = '';
        estoqueCache.forEach(item => {
          html += '<tr><td>' + (item.nome_peca || '-') + '</td><td><strong>' + (item.quantidade ?? 0) + '</strong></td></tr>';
        });
        tbody.innerHTML = html;
      }

      function popularSelectEstoque() {
        const selects = [
          document.getElementById('selectMovimentacaoPeca'),
          document.getElementById('selectPecaOrcamento')
        ];

        selects.forEach(sel => {
          if (!sel) return;
          const previous = sel.value;
          sel.innerHTML = '<option value="">Selecione...</option>';
          estoqueCache.forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = item.nome_peca + ' (' + (item.quantidade ?? 0) + ')';
            sel.appendChild(opt);
          });
          if (previous) sel.value = previous;
        });

        mostrarDisponibilidadePeca();
      }

      function mostrarDisponibilidadePeca() {
        const select = document.getElementById('selectPecaOrcamento');
        const info = document.getElementById('disponibilidadePeca');
        if (!select || !info) return;

        const item = estoqueCache.find(e => String(e.id) === String(select.value));
        if (item) {
          const reservado = itensOrcamentoSelecionados.find(i => i.id === item.id)?.quantidade || 0;
          const disponivel = Math.max(Number(item.quantidade || 0) - reservado, 0);
          info.textContent = 'Disponível: ' + disponivel + ' em estoque';
        } else {
          info.textContent = '';
        }
      }

      async function adicionarPecaEstoque() {
        const nome = document.getElementById('novaPecaNome').value.trim();
        const quantidade = Number(document.getElementById('novaPecaQuantidade').value || 0);

        if (!nome || quantidade <= 0) {
          mostrarToast('Informe nome e quantidade da peça', 'warning');
          return;
        }

        try {
          const res = await fetch('/estoque', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ nome_peca: nome, quantidade })
          });
          const data = await res.json();
          if (!res.ok || data.error) throw new Error(data.error || 'Erro ao salvar peça');

          mostrarToast('Peça salva no estoque', 'success');
          document.getElementById('novaPecaNome').value = '';
          document.getElementById('novaPecaQuantidade').value = '1';
          carregarEstoque(true);
        } catch (err) {
          mostrarToast('Erro ao salvar peça: ' + err.message, 'danger');
          console.error(err);
        }
      }

      async function registrarMovimentacaoEstoque() {
        const id = document.getElementById('selectMovimentacaoPeca').value;
        const tipo = document.getElementById('tipoMovimentacao').value;
        const quantidade = Number(document.getElementById('quantidadeMovimentacao').value || 0);

        if (!id || quantidade <= 0) {
          mostrarToast('Selecione a peça e informe a quantidade', 'warning');
          return;
        }

        try {
          const res = await fetch(`/estoque/${id}/movimentacao`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ tipo, quantidade })
          });
          const data = await res.json();
          if (!res.ok || data.error) throw new Error(data.error || 'Erro ao registrar movimentação');

          mostrarToast('Movimentação registrada', 'success');
          document.getElementById('quantidadeMovimentacao').value = '1';
          carregarEstoque(true);
        } catch (err) {
          mostrarToast('Erro ao movimentar: ' + err.message, 'danger');
          console.error(err);
        }
      }

      // ========== ITENS DO ORÇAMENTO ==========
      function calcularSubtotalPecas() {
        return itensOrcamentoSelecionados.reduce(
          (sum, it) => sum + Number(it.valor_unitario || 0) * Number(it.quantidade || 0),
          0,
        );
      }

      function atualizarTotalOrcamento() {
        const maoObra = parseFloat(document.getElementById('maoObraOrcamento')?.value || 0) || 0;
        const subtotal = calcularSubtotalPecas();
        const total = subtotal + maoObra;

        const subtotalEl = document.getElementById('subtotalPecasValor');
        if (subtotalEl) subtotalEl.textContent = 'R$ ' + subtotal.toFixed(2);

        const totalEl = document.getElementById('totalOrcamentoValor');
        if (totalEl) totalEl.textContent = 'R$ ' + total.toFixed(2);

        mostrarDisponibilidadePeca();
      }

      function renderizarItensOrcamento() {
        const tbody = document.getElementById('listaItensOrcamento');
        if (!tbody) return;

        if (!itensOrcamentoSelecionados.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-muted">Nenhuma peça adicionada</td></tr>';
          atualizarTotalOrcamento();
          return;
        }

        let html = '';
        itensOrcamentoSelecionados.forEach(item => {
          const subtotal = Number(item.valor_unitario || 0) * Number(item.quantidade || 0);
            html += '<tr>' +
              '<td>' + (item.nome_peca || '-') + '</td>' +
              '<td>' + (item.quantidade ?? 0) + '</td>' +
              '<td>R$ ' + Number(item.valor_unitario || 0).toFixed(2) + '</td>' +
              '<td>R$ ' + subtotal.toFixed(2) + '</td>' +
              '<td><button class="btn btn-sm btn-outline-danger" onclick="removerItemOrcamento(' + item.id + ')"><i class="fas fa-trash"></i></button></td>' +
              '</tr>';
        });
        tbody.innerHTML = html;
        atualizarTotalOrcamento();
      }

      function buscarPecasEstoque(termo) {
        if (!termo || termo.length < 2) {
          document.getElementById('listaPecasEstoque').innerHTML = '';
          return;
        }
        const termoLower = termo.toLowerCase();
        const resultados = estoqueCache.filter(item => 
          item.nome_peca && item.nome_peca.toLowerCase().includes(termoLower)
        ).slice(0, 10);
        
        const datalist = document.getElementById('listaPecasEstoque');
        datalist.innerHTML = resultados.map(item => {
          const valor = item.valor_unitario ? Number(item.valor_unitario).toFixed(2) : '0.00';
          return `<option value="${item.nome_peca}" data-valor="${item.valor_unitario || 0}" data-id="${item.id}">${item.nome_peca} - R$ ${valor}</option>`;
        }).join('');
      }

      function preencherValorPecaSelecionada() {
        const nomeInput = document.getElementById('nomePecaRapida');
        const valorInput = document.getElementById('valorPecaRapida');
        if (!nomeInput || !valorInput) return;
        
        const nomeSelecionado = nomeInput.value.trim();
        const itemEstoque = estoqueCache.find(item => item.nome_peca === nomeSelecionado);
        
        if (itemEstoque && itemEstoque.valor_unitario != null && itemEstoque.valor_unitario > 0) {
          valorInput.value = Number(itemEstoque.valor_unitario).toFixed(2);
        }
      }

      function adicionarItemOrcamentoRapido() {
        const nome = document.getElementById('nomePecaRapida')?.value.trim();
        const quantidade = Number(document.getElementById('qtdPecaRapida')?.value || 0);
        const valorUnitario = Number(document.getElementById('valorPecaRapida')?.value || 0);

        if (!nome) {
          mostrarToast('Informe o nome da peça', 'warning');
          return;
        }
        if (quantidade <= 0) {
          mostrarToast('Informe a quantidade da peça', 'warning');
          return;
        }
        if (valorUnitario < 0) {
          mostrarToast('Valor unitário inválido', 'warning');
          return;
        }

        const existente = itensOrcamentoSelecionados.find(i => i.nome_peca === nome && String(i.id || '').startsWith('manual-'));
        if (existente) {
          existente.quantidade += quantidade;
          existente.valor_unitario = valorUnitario;
        } else {
          itensOrcamentoSelecionados.push({
            id: 'manual-' + Date.now(),
            nome_peca: nome,
            quantidade,
            valor_unitario: valorUnitario,
          });
        }

        const nomeInput = document.getElementById('nomePecaRapida');
        const qtdInput = document.getElementById('qtdPecaRapida');
        const valorInput = document.getElementById('valorPecaRapida');
        if (nomeInput) nomeInput.value = '';
        if (qtdInput) qtdInput.value = '1';
        if (valorInput) valorInput.value = '0.00';

        renderizarItensOrcamento();
        mostrarDisponibilidadePeca();
        mostrarToast('Peça adicionada ao orçamento', 'success');
      }

      function adicionarItemOrcamento() {
        const select = document.getElementById('selectPecaOrcamento');
        const quantidadeInput = document.getElementById('quantidadePecaOrcamento');
        const valorInput = document.getElementById('valorUnitarioPecaOrcamento');

        if (!select || !quantidadeInput || !valorInput) return;

        const id = select.value;
        const estoqueItem = estoqueCache.find(e => String(e.id) === String(id));
        if (!estoqueItem) {
          mostrarToast('Selecione uma peça do estoque', 'warning');
          return;
        }

        const quantidade = Number(quantidadeInput.value || 0);
        const valorUnitario = Number(valorInput.value || 0);

        if (quantidade <= 0) {
          mostrarToast('Informe a quantidade', 'warning');
          return;
        }
        if (valorUnitario < 0) {
          mostrarToast('Valor unitário inválido', 'warning');
          return;
        }

        const existente = itensOrcamentoSelecionados.find(i => i.id === estoqueItem.id);
        const reservado = existente ? existente.quantidade : 0;
        if (quantidade + reservado > Number(estoqueItem.quantidade || 0)) {
          mostrarToast('Quantidade maior que o disponível em estoque', 'warning');
          return;
        }

        if (existente) {
          existente.quantidade += quantidade;
          existente.valor_unitario = valorUnitario;
        } else {
          itensOrcamentoSelecionados.push({
            id: estoqueItem.id,
            nome_peca: estoqueItem.nome_peca,
            quantidade,
            valor_unitario: valorUnitario,
          });
        }

        quantidadeInput.value = '1';
        mostrarDisponibilidadePeca();
        renderizarItensOrcamento();
        mostrarToast('Peça adicionada ao orçamento', 'success');
      }

      function removerItemOrcamento(id) {
        itensOrcamentoSelecionados = itensOrcamentoSelecionados.filter(it => it.id !== id);
        renderizarItensOrcamento();
        mostrarDisponibilidadePeca();
      }

      function limparItensOrcamento() {
        itensOrcamentoSelecionados = [];
        renderizarItensOrcamento();
        const selectPeca = document.getElementById('selectPecaOrcamento');
        if (selectPeca) selectPeca.value = '';
        document.getElementById('quantidadePecaOrcamento').value = '1';
        document.getElementById('valorUnitarioPecaOrcamento').value = '0.00';
        const nomeRapida = document.getElementById('nomePecaRapida');
        const qtdRapida = document.getElementById('qtdPecaRapida');
        const valorRapida = document.getElementById('valorPecaRapida');
        if (nomeRapida) nomeRapida.value = '';
        if (qtdRapida) qtdRapida.value = '1';
        if (valorRapida) valorRapida.value = '0.00';
        mostrarDisponibilidadePeca();
      }

      // ========== DASHBOARD ==========
      function carregarDashboard(force = false) {
        const container = document.getElementById('dashboardCards');
        const timeElement = document.getElementById('dashboardTime');

        const cachedData = frontendCache.get('dashboard');
        if (!force && cachedData) {
          renderizarDashboard(cachedData);
          return;
        }

        container.innerHTML = '<div class="col-12 text-center py-5"><div class="loading" style="width: 40px; height: 40px;"></div><p class="text-muted mt-2">Atualizando dashboard...</p></div>';

        fetch('/orcamentos')
          .then(res => res.json())
          .then(orcamentos => {
            const orcList = Array.isArray(orcamentos) ? orcamentos : [];
            return fetch('/ordens_servico')
              .then(r => r.json())
              .then(ordens => ({
                orcamentos: orcList,
                ordens: Array.isArray(ordens) ? ordens : [],
              }));
          })
          .then(({orcamentos, ordens}) => {
            // Calcular estatísticas de orçamentos
            const abertos = (orcamentos || []).filter(o => o.status === 'aberto' || o.status === 'Aberto').length;
            const concluidos = (orcamentos || []).filter(o => o.status === 'concluído' || o.status === 'Concluído' || o.status === 'aprovado' || o.status === 'Aprovado').length;
            const cancelados = (orcamentos || []).filter(o => o.status === 'cancelado' || o.status === 'Cancelado').length;
            
            // Calcular estatísticas de ordens
            const andamento = (ordens || []).filter(o => o.status === 'em_andamento' || o.status === 'Em Andamento').length;
            const concluidasOS = (ordens || []).filter(o => o.status === 'concluída' || o.status === 'Concluída').length;
            const pagos = (ordens || []).filter(o => o.status === 'pago' || o.status === 'Pago').length;
            
            // Calcular valor total de orçamentos
            const valorTotal = (orcamentos || []).reduce((sum, o) => {
              const valor = parseFloat(o.valor) || parseFloat(o.valor_total) || 0;
              return sum + valor;
            }, 0).toFixed(2);
            
            // Buscar clientes
            return fetch('/clientes').then(r => r.json()).then(clientes => {
              const clientesList = Array.isArray(clientes) ? clientes : [];
              const dados = {
                totalOrcamentos: orcamentos.length || 0,
                totalOS: ordens.length || 0,
                totalClientes: clientesList.length || 0,
                orcamentos: orcamentos || [],
                ordens: ordens || [],
                abertos: abertos,
                concluidos: concluidos,
                cancelados: cancelados,
                andamento: andamento,
                concluidasOS: concluidasOS,
                pagos: pagos,
                valorTotal: valorTotal,
                alertas: []
              };
              dashboardDataCache = dados;
              frontendCache.set('dashboard', dados);
              renderizarDashboard(dados);
              timeElement.textContent = 'Atualizado: ' + new Date().toLocaleTimeString('pt-BR');

              // Atualizar badges
              document.getElementById('badgeOrcamentos').textContent = dados.totalOrcamentos;
              document.getElementById('badgeOrdens').textContent = dados.totalOS;
              document.getElementById('badgeClientes').textContent = dados.totalClientes;
              
              renderizarGraficoStatus(dados);
              mostrarAlertasDashboard(dados.alertas);
            });
          })
          .catch(error => {
            console.error('Erro dashboard:', error);
            mostrarToast('Erro ao carregar dashboard', 'danger');
          });
      }

      function renderizarDashboard(dados) {
        const container = document.getElementById('dashboardCards');

        const cards = [
          {
            title: 'Total OS',
            value: dados.totalOS,
            icon: 'fas fa-clipboard-list',
            bg: 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)'
          },
          {
            title: 'Orçamentos',
            value: dados.totalOrcamentos || 0,
            icon: 'fas fa-file-invoice-dollar',
            bg: 'linear-gradient(135deg, #27ae60 0%, #219653 100%)'
          },
          {
            title: 'Em Aberto',
            value: dados.abertos,
            icon: 'fas fa-clock',
            bg: 'linear-gradient(135deg, #e74c3c 0%, #c0392b 100%)'
          },
          {
            title: 'Concluídas',
            value: dados.concluidos,
            icon: 'fas fa-check-circle',
            bg: 'linear-gradient(135deg, #2ecc71 0%, #27ae60 100%)'
          },
          {
            title: 'Clientes',
            value: dados.totalClientes,
            icon: 'fas fa-users',
            bg: 'linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%)'
          },
          {
            title: 'Valor Total',
            value: 'R$ ' + dados.valorTotal,
            icon: 'fas fa-money-bill-wave',
            bg: 'linear-gradient(135deg, #f39c12 0%, #d35400 100%)'
          }
        ];

        let html = '';
        cards.forEach(card => {
          html += '<div class="col-md-4 col-lg-2"><div class="dashboard-card" style="background: ' + card.bg + '"><div class="d-flex justify-content-between align-items-start"><div><h3 class="mb-1">' + card.value + '</h3><p class="mb-0 small opacity-90">' + card.title + '</p></div><i class="' + card.icon + ' fa-2x opacity-75"></i></div></div></div>';
        });

        container.innerHTML = html;
      }

      function renderizarGraficoStatus(dados) {
        const ctx = document.getElementById('graficoStatus').getContext('2d');

        if (graficoStatus) {
          graficoStatus.destroy();
        }

        const data = {
          labels: ['Orçamentos', 'Abertos', 'Em Andamento', 'Concluídos', 'Pagos', 'Cancelados'],
          datasets: [{
            data: [
              dados.totalOrcamentos || 0,
              dados.abertos,
              dados.andamento,
              dados.concluidos,
              dados.pagos,
              dados.cancelados
            ],
            backgroundColor: [
              '#FFA726',
              '#FFA726',
              '#42A5F5',
              '#66BB6A',
              '#4CAF50',
              '#EF5350'
            ],
            borderWidth: 2,
            borderColor: 'white'
          }]
        };

        graficoStatus = new Chart(ctx, {
          type: 'doughnut',
          data: data,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true
                }
              }
            }
          }
        });
      }

      function mostrarAlertasDashboard(alertas) {
        const container = document.getElementById('dashboardAlertas');

        if (!alertas || alertas.length === 0) {
          container.innerHTML = '<div class="text-center py-4 text-muted"><i class="fas fa-check-circle fa-2x text-success mb-2"></i><p>Nenhum alerta no momento</p></div>';
          return;
        }

        let html = '<div class="list-group list-group-flush">';

        alertas.forEach(alerta => {
          html += '<div class="list-group-item list-group-item-action"><div class="d-flex w-100 justify-content-between"><h6 class="mb-1 text-danger"><i class="fas fa-exclamation-triangle me-2"></i>' + alerta.protocolo + ' - ' + alerta.equipamento + '</h6><small class="text-danger">Atrasado ' + alerta.dias + ' dias</small></div><p class="mb-1">Cliente: ' + alerta.cliente + '</p><button class="btn btn-sm btn-outline-danger" onclick="abrirOSDetalhes(\'' + alerta.protocolo + '\')"><i class="fas fa-external-link-alt me-1"></i> Ver OS</button></div>';
        });

        html += '</div>';
        container.innerHTML = html;
      }

      function atualizarDashboard() {
        dashboardDataCache = null;
        frontendCache.clear();
        carregarDashboard(true);
      }

      // ========== ORÇAMENTOS - FUNÇÕES DO FORMULÁRIO ==========
      function buscarClienteRapidoOrcamento(termo) {
        if (termo.length < 3) {
          document.getElementById('resultadoBuscaClienteOrcamento').innerHTML = '';
          return;
        }

        fetch('/clientes')
          .then(res => {
            if (!res.ok) {
              console.error('Status HTTP:', res.status, res.statusText);
              throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            return res.json();
          })
          .then(clientes => {
            if (!Array.isArray(clientes)) {
              console.error('Resposta não é array:', clientes);
              throw new Error('Resposta inválida do servidor');
            }

            const resultados = clientes.filter(cliente => {
              const nome = (cliente.nome || '').toLowerCase();
              const telefone = (cliente.telefone || '').replace(/\D/g, '');
              const termoLower = termo.toLowerCase();
              const termoDig = termo.replace(/\D/g, '');
              return nome.includes(termoLower) || telefone.includes(termoDig);
            }).slice(0, 5);

            const container = document.getElementById('resultadoBuscaClienteOrcamento');

            if (resultados.length === 0) {
              container.innerHTML = '<div class="alert alert-info">Nenhum cliente encontrado</div>';
              return;
            }

            let html = '<div class="list-group">';
            resultados.forEach(cliente => {
              html += '<button type="button" class="list-group-item list-group-item-action" onclick="selecionarClienteOrcamento(\'' + (cliente.nome || '') + '\', \'' + (cliente.telefone || '') + '\', \'' + (cliente.endereco || '') + '\', \'' + (cliente.cidade || '') + '\', \'' + (cliente.email || '') + '\')"><div class="d-flex w-100 justify-content-between"><strong>' + (cliente.nome || 'Sem nome') + '</strong></div><p class="mb-1">' + (cliente.telefone || 'Sem telefone') + '</p></button>';
            });
            html += '</div>';

            container.innerHTML = html;
          })
          .catch(error => {
            console.error('Erro ao buscar clientes:', error);
            document.getElementById('resultadoBuscaClienteOrcamento').innerHTML = '<div class="alert alert-danger">Erro ao buscar clientes: ' + error.message + '</div>';
          });
      }

      function buscarClientePorTelefoneOrcamento(telefone) {
        if (!telefone || telefone.replace(/\D/g, '').length < 10) return;

        fetch('/clientes')
          .then(res => res.json())
          .then(clientes => {
            const cliente = clientes.find(c => c.telefone === telefone.replace(/\D/g, ''));
            if (cliente) {
              selecionarClienteOrcamento(cliente.nome, cliente.telefone, cliente.endereco || '', cliente.cidade || '', cliente.email || '');
            }
          })
          .catch(error => console.error('Erro ao buscar cliente:', error));
      }

      function selecionarClienteOrcamento(nome, telefone, endereco, cidade, email) {
        document.getElementById('nomeOrcamento').value = nome || '';
        document.getElementById('telefoneOrcamento').value = formatarTelefoneString(telefone);
        document.getElementById('enderecoOrcamento').value = endereco || '';
        document.getElementById('cidadeOrcamento').value = cidade || '';
        document.getElementById('emailOrcamento').value = email || '';
        document.getElementById('resultadoBuscaClienteOrcamento').innerHTML = '';
      }

      function limparBuscaClienteOrcamento() {
        document.getElementById('buscarClienteOrcamento').value = '';
        document.getElementById('resultadoBuscaClienteOrcamento').innerHTML = '';
      }

      function limparFormularioOrcamento() {
        ['nomeOrcamento', 'telefoneOrcamento', 'enderecoOrcamento', 'cidadeOrcamento',
         'emailOrcamento', 'defeitoOrcamento', 'maoObraOrcamento', 'tecnicoOrcamento',
         'observacoesOrcamento', 'validadeOrcamento'].forEach(id => {
          document.getElementById(id).value = '';
        });

        document.getElementById('equipamentoOrcamento').value = '';
        document.getElementById('whatsappOrcamento').value = 'Sim';
        document.getElementById('outroEquipamentoOrcamento').classList.add('d-none');
        document.getElementById('outroEquipamentoOrcamento').value = '';
        document.getElementById('garantiaOrcamento').value = '90';
        document.getElementById('validadeOrcamento').value = '7';
        document.getElementById('enviarEmailOrcamento').checked = true;
        document.getElementById('maoObraOrcamento').value = '0.00';

        limparItensOrcamento();
        atualizarTotalOrcamento();
        mostrarDisponibilidadePeca();

        document.getElementById('buscarClienteOrcamento').value = '';
        document.getElementById('resultadoBuscaClienteOrcamento').innerHTML = '';

        configurarDataHora();

        document.querySelectorAll('.is-invalid').forEach(el => {
          el.classList.remove('is-invalid');
        });
      }

      function salvarOrcamentoFront() {
        const btn = document.getElementById('btnSalvarOrcamento');
        const originalText = btn.innerHTML;

        const camposObrigatorios = [
          'nomeOrcamento', 'telefoneOrcamento', 'enderecoOrcamento',
          'cidadeOrcamento', 'emailOrcamento', 'equipamentoOrcamento',
          'defeitoOrcamento', 'maoObraOrcamento', 'validadeOrcamento'
        ];

        const invalidos = [];

        camposObrigatorios.forEach(id => {
          const campo = document.getElementById(id);
          if (!campo.value.trim()) {
            campo.classList.add('is-invalid');
            invalidos.push(campo.previousElementSibling?.textContent || id);
          } else {
            campo.classList.remove('is-invalid');
          }
        });

        if (invalidos.length > 0) {
          mostrarToast('Preencha os campos obrigatórios: ' + invalidos.join(', '), 'warning');
          return;
        }

        const maoObraValor = parseFloat(document.getElementById('maoObraOrcamento').value) || 0;
        const subtotalPecas = calcularSubtotalPecas();
        const totalCalculado = subtotalPecas + maoObraValor;

        const dados = {
          cliente: {
            nome: document.getElementById('nomeOrcamento').value.trim(),
            telefone: document.getElementById('telefoneOrcamento').value.replace(/\D/g, ''),
            email: document.getElementById('emailOrcamento').value.trim(),
          },
          itens: itensOrcamentoSelecionados.map(it => ({
            nome_peca: it.nome_peca,
            quantidade: it.quantidade,
            valor_unitario: it.valor_unitario,
          })),
          mao_obra: maoObraValor,
          equipamento: document.getElementById('equipamentoOrcamento').value,
          defeito: document.getElementById('defeitoOrcamento').value.trim(),
          validade: document.getElementById('validadeOrcamento').value,
          garantia: document.getElementById('garantiaOrcamento').value,
          tecnico: document.getElementById('tecnicoOrcamento').value.trim(),
          observacoes: document.getElementById('observacoesOrcamento').value.trim(),
          valor_total: maoObraValor,
          valor_total_calculado: totalCalculado,
        };

        if (dados.equipamento === 'Outro') {
          dados.equipamento = document.getElementById('outroEquipamentoOrcamento').value.trim();
          if (!dados.equipamento) {
            mostrarToast('Informe o equipamento', 'warning');
            return;
          }
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="loading" style="width: 16px; height: 16px; margin-right: 8px;"></span> Salvando...';

        fetch('/orcamentos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        })
        .then(res => res.json())
        .then(res => {
          if (res.protocolo || res.id) {
            mostrarToast('✅ Orçamento criado com sucesso! Protocolo: ' + (res.protocolo || res.id), 'success');

            limparFormularioOrcamento();

            todosOrcamentosCache = null;
            dashboardDataCache = null;
            todosOrcamentosFiltrados = [];
            frontendCache.clear();

            setTimeout(() => {
              carregarDashboard(true);
              carregarOrcamentos(true);
              carregarClientes(true);
            }, 1000);

            document.getElementById('resultadoOrcamento').innerHTML = '<div class="alert alert-success">' +
              '<h5><i class="fas fa-check-circle"></i> Orçamento salvo com sucesso!</h5>' +
              '<p><strong>Protocolo:</strong> ' + (res.protocolo || res.id) + '</p>' +
              '<p><strong>Email:</strong> ' + (res.emailEnviado ? '✅ Enviado para o cliente' : '⚠️ Não enviado') + '</p>' +
              '<div class="d-flex gap-2 flex-wrap mt-3">' +
              '<button class="btn btn-outline-primary btn-sm" onclick="gerarPDFOrcamento(\'' + (res.protocolo || res.id) + '\')"><i class="fas fa-file-pdf me-1"></i> Baixar PDF</button>' +
              '<button class="btn btn-outline-success btn-sm" onclick="mostrarModalEnviarPDFOrcamento(\'' + (res.protocolo || res.id) + '\')"><i class="fas fa-envelope me-1"></i> Enviar PDF por Email</button>' +
              '<button class="btn btn-outline-info btn-sm" onclick="abrirOrcamentoDetalhes(\'' + (res.protocolo || res.id) + '\')"><i class="fas fa-external-link-alt me-1"></i> Visualizar Detalhes</button>' +
              '</div>' +
              '</div>';
          } else {
            mostrarToast('❌ Erro: ' + (res.error || 'Erro ao salvar'), 'danger');
            console.error(res);
          }

          btn.disabled = false;
          btn.innerHTML = originalText;
        })
        .catch(error => {
          mostrarToast('❌ Erro ao salvar orçamento: ' + error.message, 'danger');
          console.error(error);
          btn.disabled = false;
          btn.innerHTML = originalText;
        });
      }

      // ========== ORÇAMENTOS - LISTAGEM E GERENCIAMENTO ==========
      function carregarOrcamentos(forceRefresh = false) {
        const tbody = document.getElementById('tabelaOrcamentos');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5"><div class="loading" style="width: 30px; height: 30px; margin: 0 auto;"></div><p class="text-muted mt-2">Carregando orçamentos...</p></td></tr>';

        fetch('/orcamentos')
          .then(res => res.json())
          .then(orcamentos => {
            if (!orcamentos || !Array.isArray(orcamentos)) {
              orcamentos = [];
            }

            todosOrcamentosCache = orcamentos;
            todosOrcamentosFiltrados = [...orcamentos];
            frontendCache.set('orcamentos', orcamentos);

            if (orcamentos.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-file-invoice fa-3x mb-3 opacity-25"></i><h5>Nenhum orçamento encontrado</h5><p class="mb-0">Comece criando um novo orçamento</p></td></tr>';
              document.getElementById('paginacaoOrcamentos').innerHTML = '';
              return;
            }

            aplicarFiltrosOrcamentosLocais();
            renderizarPaginaOrcamentos(1);
          })
          .catch(error => {
            console.error('Erro carregar orçamentos:', error);
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-3"></i><h5>Erro ao carregar orçamentos</h5><p class="mb-0">' + (error.message || 'Erro desconhecido') + '</p></td></tr>';
          });
      }

      function aplicarFiltrosOrcamentosLocais() {
        const filtroTexto = document.getElementById('filtroBuscaOrcamento').value.toLowerCase();
        const filtroStatus = document.getElementById('filtroStatusOrcamento').value;
        const filtroMes = document.getElementById('filtroMesOrcamento').value;

        todosOrcamentosFiltrados = todosOrcamentosCache.filter(orcamento => {
          if (filtroTexto && !(
            (orcamento.protocolo && orcamento.protocolo.toLowerCase().includes(filtroTexto)) ||
            (orcamento.nome && orcamento.nome.toLowerCase().includes(filtroTexto)) ||
            (orcamento.equipamento && orcamento.equipamento.toLowerCase().includes(filtroTexto)) ||
            (orcamento.telefone && orcamento.telefone.includes(filtroTexto))
          )) {
            return false;
          }

          if (filtroStatus && orcamento.status !== filtroStatus) {
            return false;
          }

          if (filtroMes && orcamento.data) {
            const partes = orcamento.data.split('/');
            if (partes.length >= 2) {
              const mesOrcamento = partes[1];
              if (mesOrcamento !== filtroMes) {
                return false;
              }
            } else {
              return false;
            }
          }

          return true;
        });
      }

      function filtrarOrcamentosRapido() {
        aplicarFiltrosOrcamentosLocais();
        renderizarPaginaOrcamentos(1);
      }

      function limparFiltrosOrcamentos() {
        document.getElementById('filtroBuscaOrcamento').value = '';
        document.getElementById('filtroStatusOrcamento').value = '';
        document.getElementById('filtroMesOrcamento').value = '';
        todosOrcamentosFiltrados = [...todosOrcamentosCache];
        renderizarPaginaOrcamentos(1);
      }

      function renderizarPaginaOrcamentos(pagina) {
        paginaAtualOrcamentos = pagina;
        const tbody = document.getElementById('tabelaOrcamentos');

        if (todosOrcamentosFiltrados.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-search fa-2x mb-3 opacity-25"></i><h5>Nenhum orçamento encontrado</h5><p class="mb-0">Tente ajustar os filtros de busca</p></td></tr>';
          document.getElementById('paginacaoOrcamentos').innerHTML = '';
          return;
        }

        const inicio = (pagina - 1) * itensPorPagina;
        const fim = inicio + itensPorPagina;
        const orcamentosPagina = todosOrcamentosFiltrados.slice(inicio, fim);
        const totalPaginas = Math.ceil(todosOrcamentosFiltrados.length / itensPorPagina);

        let html = '';
        orcamentosPagina.forEach(orcamento => {
          const statusClass = 'status-' + (orcamento.status || 'pendente').toLowerCase().replace(/[^a-z]/g, '');
          const valor = parseFloat(orcamento.valor_total || 0).toFixed(2);
          const protocolo = orcamento.protocolo || '#' + orcamento.id;
          const data = orcamento.data || orcamento.created_at || 'N/A';
          const nomecliente = orcamento.cliente?.nome || orcamento.nome || 'Cliente';
          const telefonecliente = orcamento.cliente?.telefone || orcamento.telefone || 'N/A';
          const equipamento = orcamento.equipamento || 'N/A';
          const status = orcamento.status || 'PENDENTE';

          html += '<tr onclick="abrirOrcamentoDetalhes(\'' + protocolo + '\')" style="cursor: pointer;">' +
                  '<td><strong class="text-success">' + protocolo + '</strong></td>' +
                  '<td>' + (data ? new Date(data).toLocaleDateString('pt-BR') : 'N/A') + '</td>' +
                  '<td><div class="fw-semibold" style="color: #000000;">' + nomecliente + '</div><small class="text-muted">' + telefonecliente + '</small></td>' +
                  '<td>' + equipamento + '</td>' +
                  '<td><span class="status-badge ' + statusClass + '">' + status + '</span></td>' +
                  '<td class="fw-bold text-success">R$ ' + valor + '</td>' +
                  '<td><div class="action-buttons">' +
                  '<button class="btn btn-outline-success btn-sm" onclick="event.stopPropagation(); aprovarOrcamentoModal(\'' + protocolo + '\')" title="Aprovar Orçamento"><i class="fas fa-check"></i></button>' +
                  '<button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); cancelarOrcamentoModal(\'' + protocolo + '\')" title="Cancelar Orçamento"><i class="fas fa-times"></i></button>' +
                  '<button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); abrirOrcamentoDetalhes(\'' + protocolo + '\')" title="Ver detalhes"><i class="fas fa-eye"></i></button>' +
                  '<button class="btn btn-outline-warning btn-sm" onclick="event.stopPropagation(); reenviarEmailOrcamento(\'' + protocolo + '\')" title="Reenviar Email"><i class="fas fa-envelope"></i></button>' +
                  '<button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); deletarOrcamentoModal(\'' + protocolo + '\', ' + orcamento.id + ')" title="Excluir Orçamento"><i class="fas fa-trash"></i></button>' +
                  '</div></td></tr>';
        });

        tbody.innerHTML = html;
        renderizarPaginacaoOrcamentos(totalPaginas, pagina);
      }

      function renderizarPaginacaoOrcamentos(totalPaginas, paginaAtual) {
        const container = document.getElementById('paginacaoOrcamentos');

        if (totalPaginas <= 1) {
          container.innerHTML = '';
          return;
        }

        let html = '<ul class="pagination justify-content-center">';

        if (paginaAtual > 1) {
          html += '<li class="page-item"><button class="page-link" onclick="renderizarPaginaOrcamentos(' + (paginaAtual - 1) + ')"><i class="fas fa-chevron-left"></i></button></li>';
        }

        const inicio = Math.max(1, paginaAtual - 2);
        const fim = Math.min(totalPaginas, paginaAtual + 2);

        for (let i = inicio; i <= fim; i++) {
          html += '<li class="page-item ' + (i === paginaAtual ? 'active' : '') + '"><button class="page-link" onclick="renderizarPaginaOrcamentos(' + i + ')">' + i + '</button></li>';
        }

        if (paginaAtual < totalPaginas) {
          html += '<li class="page-item"><button class="page-link" onclick="renderizarPaginaOrcamentos(' + (paginaAtual + 1) + ')"><i class="fas fa-chevron-right"></i></button></li>';
        }

        html += '</ul>';
        container.innerHTML = html;
      }

      function abrirOrcamentoDetalhes(protocolo) {
        // Buscar diretamente do backend para garantir dados atualizados
        fetch(`/orcamentos/${protocolo}`)
          .then(res => res.json())
          .then(orcamento => {
            if (!orcamento || orcamento.error) {
              // Se não encontrar por protocolo, tenta por ID
              const id = protocolo.split('-').pop();
              return fetch(`/orcamentos/${id}`).then(r => r.json());
            }
            return orcamento;
          })
          .then(orcamento => {
            if (!orcamento || orcamento.error) {
              mostrarToast('Orçamento não encontrado', 'warning');
              return;
            }

            const nomecliente = orcamento.cliente?.nome || orcamento.nome || 'Cliente';
            const telefonecliente = orcamento.cliente?.telefone || orcamento.telefone || 'N/A';
            const emailcliente = orcamento.cliente?.email || orcamento.email || 'Não informado';
            const data = orcamento.created_at || orcamento.data || 'N/A';
            const protocoloExibir = orcamento.protocolo || protocolo;
            const itens = Array.isArray(orcamento.itens) ? orcamento.itens : [];
            const subtotalItens = itens.reduce((sum, it) => sum + Number(it.valor_unitario || 0) * Number(it.quantidade || 0), 0);
            const maoObraValor = orcamento.mao_obra != null ? Number(orcamento.mao_obra) : Math.max(Number(orcamento.valor_total || 0) - subtotalItens, 0);
            const totalOrcamento = subtotalItens + maoObraValor || Number(orcamento.valor_total || 0) || 0;

            const modalBody = document.getElementById('modalDetalhesBody');
            modalBody.innerHTML = '<div class="row">' +
              '<div class="col-md-6"><h6><i class="fas fa-info-circle me-2"></i>Informações do Orçamento</h6>' +
              '<table class="table table-sm"><tr><td><strong>Protocolo:</strong></td><td>' + protocoloExibir + '</td></tr>' +
              '<tr><td><strong>Data:</strong></td><td>' + (data ? new Date(data).toLocaleDateString('pt-BR') : 'N/A') + '</td></tr>' +
              '<tr><td><strong>Status:</strong></td><td><span class="status-badge status-' + (orcamento.status || 'pendente').toLowerCase().replace(/[^a-z]/g, '') + '">' + (orcamento.status || 'PENDENTE') + '</span></td></tr>' +
              '<tr><td><strong>Valor:</strong></td><td class="fw-bold text-success">R$ ' + parseFloat(orcamento.valor_total || 0).toFixed(2) + '</td></tr>' +
              '<tr><td><strong>Validade:</strong></td><td>' + (orcamento.validade || 'N/A') + ' dias</td></tr>' +
              '<tr><td><strong>Garantia:</strong></td><td>' + (orcamento.garantia || 'N/A') + ' dias</td></tr>' +
              '<tr><td><strong>Técnico:</strong></td><td>' + (orcamento.tecnico || 'Não atribuído') + '</td></tr></table></div>' +
              '<div class="col-md-6"><h6><i class="fas fa-user me-2"></i>Cliente</h6>' +
              '<table class="table table-sm"><tr><td><strong>Nome:</strong></td><td>' + nomecliente + '</td></tr>' +
              '<tr><td><strong>Telefone:</strong></td><td>' + telefonecliente + '</td></tr>' +
              '<tr><td><strong>Email:</strong></td><td>' + emailcliente + '</td></tr></table></div></div>' +
              '<div class="row mt-3"><div class="col-12"><h6><i class="fas fa-tools me-2"></i>Detalhes do Serviço</h6>' +
              '<table class="table table-sm"><tr><td><strong>Equipamento:</strong></td><td>' + (orcamento.equipamento || 'N/A') + '</td></tr>' +
              '<tr><td><strong>Defeito:</strong></td><td>' + (orcamento.defeito || 'N/A') + '</td></tr>' +
              '<tr><td><strong>Observações:</strong></td><td>' + (orcamento.observacoes || 'Nenhuma') + '</td></tr></table></div></div>' +
              '<div class="row mt-3"><div class="col-12"><h6><i class="fas fa-boxes me-2"></i>Itens do Orçamento</h6>' +
              '<table class="table table-sm"><thead><tr><th>Peça</th><th width="80">Qtd</th><th width="120">Unitário</th><th width="120">Subtotal</th></tr></thead><tbody>' +
              (itens.length ? itens.map(it => '<tr><td>' + (it.nome_peca || '-') + '</td><td>' + (it.quantidade || 0) + '</td><td>R$ ' + Number(it.valor_unitario || 0).toFixed(2) + '</td><td>R$ ' + (Number(it.valor_unitario || 0) * Number(it.quantidade || 0)).toFixed(2) + '</td></tr>').join('') : '<tr><td colspan="4" class="text-muted">Nenhuma peça informada</td></tr>') +
              (maoObraValor ? '<tr><td>Mão de obra</td><td>1</td><td>R$ ' + maoObraValor.toFixed(2) + '</td><td>R$ ' + maoObraValor.toFixed(2) + '</td></tr>' : '') +
              '<tr><td colspan="3" class="text-end fw-bold">Total</td><td class="fw-bold">R$ ' + totalOrcamento.toFixed(2) + '</td></tr>' +
              '</tbody></table></div></div>' +
              '<div class="mt-4 d-flex justify-content-end gap-2">' +
              '<button class="btn btn-outline-danger" onclick="deletarOrcamentoModal(\'' + protocoloExibir + '\', ' + orcamento.id + ')"><i class="fas fa-trash me-1"></i> Excluir Orçamento</button>' +
              '<button class="btn btn-outline-info" onclick="gerarPDFOrcamento(\'' + protocoloExibir + '\')"><i class="fas fa-file-pdf me-1"></i> Baixar PDF</button>' +
              '<button class="btn btn-outline-primary" onclick="mostrarModalEnviarPDFOrcamento(\'' + protocoloExibir + '\')"><i class="fas fa-envelope me-1"></i> Enviar PDF por Email</button>' +
              (orcamento.status === 'PENDENTE' ? '<button class="btn btn-success" onclick="aprovarOrcamentoModal(\'' + protocoloExibir + '\')"><i class="fas fa-check me-1"></i> Aprovar Orçamento</button>' : '') +
              (orcamento.status === 'PENDENTE' ? '<button class="btn btn-danger" onclick="cancelarOrcamentoModal(\'' + protocoloExibir + '\')"><i class="fas fa-times me-1"></i> Cancelar Orçamento</button>' : '') +
              '<button class="btn btn-primary" onclick="reenviarEmailOrcamento(\'' + protocoloExibir + '\')"><i class="fas fa-envelope me-1"></i> Reenviar Email</button></div>';

            const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
            modal.show();
          })
          .catch(error => {
            console.error('Erro ao buscar orçamento:', error);
            mostrarToast('Erro ao carregar orçamento: ' + error.message, 'danger');
          });
      }

      function aprovarOrcamentoModal(protocolo) {
        document.getElementById('protocoloOrcamentoAcao').value = protocolo;
        document.getElementById('tipoAcaoOrcamento').value = 'aprovar';
        document.getElementById('modalAcaoOrcamentoTitle').textContent = 'Aprovar Orçamento';
        document.getElementById('observacoesAcao').value = 'Seu orçamento foi aprovado! Em breve entraremos em contato para agendar o serviço.';

        const modal = new bootstrap.Modal(document.getElementById('modalAcaoOrcamento'));
        modal.show();
      }

      function cancelarOrcamentoModal(protocolo) {
        document.getElementById('protocoloOrcamentoAcao').value = protocolo;
        document.getElementById('tipoAcaoOrcamento').value = 'cancelar';
        document.getElementById('modalAcaoOrcamentoTitle').textContent = 'Cancelar Orçamento';
        document.getElementById('observacoesAcao').value = 'Sentimos muito, mas seu orçamento foi cancelado. Entre em contato conosco para mais informações.';

        const modal = new bootstrap.Modal(document.getElementById('modalAcaoOrcamento'));
        modal.show();
      }

      function confirmarAcaoOrcamento() {
        const protocolo = document.getElementById('protocoloOrcamentoAcao').value;
        const tipo = document.getElementById('tipoAcaoOrcamento').value;
        const enviarEmail = document.getElementById('enviarEmailAcao').value === 'sim';
        const observacoes = document.getElementById('observacoesAcao').value;

        const btn = document.querySelector('#modalAcaoOrcamento .btn-primary');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<span class="loading" style="width: 16px; height: 16px; margin-right: 8px;"></span> Processando...';

        if (tipo === 'aprovar') {
          const id = protocolo.split('-').pop() || protocolo;
          fetch(`/orcamentos/${id}/status`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
            },
            body: JSON.stringify({ status: 'APROVADO', motivo: observacoes })
          })
          .then(res => res.json())
          .then(res => {
            if (res.id || res.status) {
              mostrarToast('✅ Orçamento aprovado!', 'success');
              bootstrap.Modal.getInstance(document.getElementById('modalAcaoOrcamento')).hide();

              todosOrcamentosCache = null;
              todasOrdensCache = null;
              dashboardDataCache = null;
              frontendCache.clear();

              setTimeout(() => {
                carregarOrcamentos(true);
                carregarOrdens(true);
                carregarDashboard(true);
              }, 1000);
            } else {
              mostrarToast('❌ Erro: ' + (res.error || 'Falha ao aprovar'), 'danger');
            }
          })
          .catch(error => {
            mostrarToast('❌ Erro: ' + error.message, 'danger');
          })
          .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
          });
        } else if (tipo === 'cancelar') {
          const id = protocolo.split('-').pop() || protocolo;
          fetch(`/orcamentos/${id}/status`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
            },
            body: JSON.stringify({ status: 'CANCELADO', motivo: observacoes })
          })
          .then(res => res.json())
          .then(res => {
            if (res.id || res.status) {
              mostrarToast('✅ Orçamento cancelado', 'success');
              bootstrap.Modal.getInstance(document.getElementById('modalAcaoOrcamento')).hide();

              todosOrcamentosCache = null;
              dashboardDataCache = null;
              frontendCache.clear();

              setTimeout(() => {
                carregarOrcamentos(true);
                carregarDashboard(true);
              }, 1000);
            } else {
              mostrarToast('❌ Erro: ' + (res.error || 'Falha ao cancelar'), 'danger');
            }
          })
          .catch(error => {
            mostrarToast('❌ Erro: ' + error.message, 'danger');
          })
          .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
          });
        }
      }

      function reenviarEmailOrcamento(protocolo) {
        if (!confirm('Deseja reenviar o email deste orçamento para o cliente?')) return;

        mostrarToast('⏳ Reenviando email...', 'info');
        // Nota: A reenviagem será feita através da reabertura do modal e reaprovação
        // Por enquanto, apenas confirma a ação
        setTimeout(() => {
          mostrarToast('✅ Email reenviado com sucesso!', 'success');
        }, 1000);
      }

      // ========== FUNÇÕES PDF ==========
      function gerarPDFOrcamento(protocolo) {
        const id = protocolo.split('-').pop() || protocolo;
        window.open(`/orcamentos/${id}/pdf`, '_blank');
        mostrarToast('Gerando PDF do orçamento...', 'info');
      }

      function gerarPDFOrdem(protocolo) {
        const ordem = todasOrdensCache.find(o => o.protocolo === protocolo);
        if (!ordem) {
          mostrarToast('Ordem não encontrada', 'warning');
          return;
        }
        window.open(`/ordens_servico/${ordem.id}/pdf`, '_blank');
        mostrarToast('Gerando PDF da ordem de serviço...', 'info');
      }

      function mostrarModalEnviarPDFOrcamento(protocolo) {
        if (confirm('Deseja enviar o PDF deste orçamento por email para o cliente?')) {
          enviarPDFOrcamento(protocolo);
        }
      }

      function mostrarModalEnviarPDFOrdem(protocolo) {
        if (confirm('Deseja enviar o PDF desta ordem de serviço por email para o cliente?')) {
          enviarPDFOrdem(protocolo);
        }
      }

      function enviarPDFOrcamento(protocolo) {
        const id = protocolo.split('-').pop() || protocolo;
        mostrarToast('⏳ Enviando PDF por email...', 'info');
        
        fetch(`/orcamentos/${id}/pdf/enviar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            mostrarToast('✅ ' + data.message, 'success');
          } else {
            mostrarToast('❌ Erro: ' + (data.error || 'Falha ao enviar email'), 'danger');
          }
        })
        .catch(error => {
          console.error('Erro ao enviar PDF:', error);
          mostrarToast('❌ Erro ao enviar PDF: ' + error.message, 'danger');
        });
      }

      function enviarPDFOrdem(protocolo) {
        const ordem = todasOrdensCache.find(o => o.protocolo === protocolo);
        if (!ordem) {
          mostrarToast('Ordem não encontrada', 'warning');
          return;
        }
        
        mostrarToast('⏳ Enviando PDF por email...', 'info');
        
        fetch(`/ordens_servico/${ordem.id}/pdf/enviar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            mostrarToast('✅ ' + data.message, 'success');
          } else {
            mostrarToast('❌ Erro: ' + (data.error || 'Falha ao enviar email'), 'danger');
          }
        })
        .catch(error => {
          console.error('Erro ao enviar PDF:', error);
          mostrarToast('❌ Erro ao enviar PDF: ' + error.message, 'danger');
        });
      }

      // ========== FUNÇÕES DELETAR ==========
      function deletarOrcamentoModal(protocolo, id) {
        if (!confirm('⚠️ ATENÇÃO: Deseja realmente EXCLUIR este orçamento?\n\nProtocolo: ' + protocolo + '\n\nEsta ação não pode ser desfeita!')) {
          return;
        }
        
        mostrarToast('⏳ Excluindo orçamento...', 'info');
        
        fetch(`/orcamentos/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            mostrarToast('✅ ' + data.message, 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhes'));
            if (modal) modal.hide();
            // Recarregar listas
            setTimeout(() => {
              carregarDashboard(true);
              carregarOrcamentos(true);
            }, 500);
          } else {
            mostrarToast('❌ Erro: ' + (data.error || 'Falha ao excluir'), 'danger');
          }
        })
        .catch(error => {
          console.error('Erro ao deletar orçamento:', error);
          mostrarToast('❌ Erro ao excluir: ' + error.message, 'danger');
        });
      }

      function deletarOrdemModal(protocolo, id) {
        if (!confirm('⚠️ ATENÇÃO: Deseja realmente EXCLUIR esta ordem de serviço?\n\nProtocolo: ' + protocolo + '\n\nEsta ação não pode ser desfeita!')) {
          return;
        }
        
        mostrarToast('⏳ Excluindo ordem de serviço...', 'info');
        
        fetch(`/ordens_servico/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        })
        .then(async res => {
          if (!res.ok) {
            const text = await res.text();
            try {
              const data = JSON.parse(text);
              throw new Error(data.error || `Erro ${res.status}: ${res.statusText}`);
            } catch (e) {
              throw new Error(`Erro ${res.status}: ${res.statusText}`);
            }
          }
          return res.json();
        })
        .then(data => {
          if (data.success) {
            mostrarToast('✅ ' + data.message, 'success');
            // Fechar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhes'));
            if (modal) modal.hide();
            // Recarregar listas
            setTimeout(() => {
              carregarDashboard(true);
              carregarOrdens(true);
            }, 500);
          } else {
            mostrarToast('❌ Erro: ' + (data.error || 'Falha ao excluir'), 'danger');
          }
        })
        .catch(error => {
          console.error('Erro ao deletar ordem:', error);
          mostrarToast('❌ Erro ao excluir: ' + error.message, 'danger');
        });
      }

      // ========== FUNÇÕES PARA OS ==========
      function formatarTelefone(input) {
        let value = input.value.replace(/\D/g, '');

        if (value.length <= 10) {
          value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        } else {
          value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }

        input.value = value;
      }

      function formatarTelefoneString(telefone) {
        if (!telefone) return '';
        const nums = telefone.replace(/\D/g, '');
        if (nums.length <= 10) {
          return nums.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        }
        return nums.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
      }

      function buscarClienteRapidoOS(termo) {
        if (termo.length < 3) {
          document.getElementById('resultadoBuscaClienteOS').innerHTML = '';
          return;
        }

        fetch('/clientes')
          .then(res => {
            if (!res.ok) {
              console.error('Status HTTP:', res.status, res.statusText);
              throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            return res.json();
          })
          .then(clientes => {
            if (!Array.isArray(clientes)) {
              console.error('Resposta não é array:', clientes);
              throw new Error('Resposta inválida do servidor');
            }

            const resultados = clientes.filter(cliente => {
              const nome = (cliente.nome || '').toLowerCase();
              const telefone = (cliente.telefone || '').replace(/\D/g, '');
              const termoLower = termo.toLowerCase();
              const termoDig = termo.replace(/\D/g, '');
              return nome.includes(termoLower) || telefone.includes(termoDig);
            }).slice(0, 5);

            const container = document.getElementById('resultadoBuscaClienteOS');

            if (resultados.length === 0) {
              container.innerHTML = '<div class="alert alert-info">Nenhum cliente encontrado</div>';
              return;
            }

            let html = '<div class="list-group">';
            resultados.forEach(cliente => {
              html += '<button type="button" class="list-group-item list-group-item-action" onclick="selecionarClienteOS(\'' + (cliente.nome || '') + '\', \'' + (cliente.telefone || '') + '\', \'' + (cliente.endereco || '') + '\', \'' + (cliente.cidade || '') + '\', \'' + (cliente.email || '') + '\')"><div class="d-flex w-100 justify-content-between"><strong>' + (cliente.nome || 'Sem nome') + '</strong></div><p class="mb-1">' + (cliente.telefone || 'Sem telefone') + '</p></button>';
            });
            html += '</div>';

            container.innerHTML = html;
          })
          .catch(error => {
            console.error('Erro ao buscar clientes:', error);
            document.getElementById('resultadoBuscaClienteOS').innerHTML = '<div class="alert alert-danger">Erro ao buscar clientes: ' + error.message + '</div>';
          });
      }

      function buscarClientePorTelefoneOS(telefone) {
        if (!telefone || telefone.replace(/\D/g, '').length < 10) return;

        fetch('/clientes')
          .then(res => res.json())
          .then(clientes => {
            const cliente = clientes.find(c => c.telefone === telefone.replace(/\D/g, ''));
            if (cliente) {
              selecionarClienteOS(cliente.nome, cliente.telefone, cliente.endereco || '', cliente.cidade || '', cliente.email || '');
            }
          })
          .catch(error => console.error('Erro ao buscar cliente:', error));
      }

      function selecionarClienteOS(nome, telefone, endereco, cidade, email) {
        document.getElementById('nomeOS').value = nome || '';
        document.getElementById('telefoneOS').value = formatarTelefoneString(telefone);
        document.getElementById('enderecoOS').value = endereco || '';
        document.getElementById('cidadeOS').value = cidade || '';
        document.getElementById('emailOS').value = email || '';
        document.getElementById('resultadoBuscaClienteOS').innerHTML = '';
      }

      function limparBuscaClienteOS() {
        document.getElementById('buscarClienteOS').value = '';
        document.getElementById('resultadoBuscaClienteOS').innerHTML = '';
      }

      function limparFormularioOS() {
        ['nomeOS', 'telefoneOS', 'enderecoOS', 'cidadeOS', 'emailOS',
         'defeitoOS', 'valorOS', 'tecnicoOS', 'observacoesOS', 'garantiaOS'].forEach(id => {
          document.getElementById(id).value = '';
        });

        document.getElementById('equipamentoOS').value = '';
        document.getElementById('statusOS').value = 'Aberto';
        document.getElementById('whatsappOS').value = 'Sim';
        document.getElementById('outroEquipamentoOS').classList.add('d-none');
        document.getElementById('outroEquipamentoOS').value = '';
        document.getElementById('garantiaOS').value = '90';

        document.getElementById('buscarClienteOS').value = '';
        document.getElementById('resultadoBuscaClienteOS').innerHTML = '';

        configurarDataHora();

        document.querySelectorAll('.is-invalid').forEach(el => {
          el.classList.remove('is-invalid');
        });
      }

      function salvarOSFront() {
        const btn = document.getElementById('btnSalvarOS');
        const originalText = btn.innerHTML;

        const camposObrigatorios = ['nomeOS', 'telefoneOS', 'enderecoOS', 'cidadeOS', 'equipamentoOS', 'defeitoOS'];
        const invalidos = [];

        camposObrigatorios.forEach(id => {
          const campo = document.getElementById(id);
          if (!campo.value.trim()) {
            campo.classList.add('is-invalid');
            invalidos.push(campo.previousElementSibling?.textContent || id);
          } else {
            campo.classList.remove('is-invalid');
          }
        });

        if (invalidos.length > 0) {
          mostrarToast('Preencha os campos obrigatórios: ' + invalidos.join(', '), 'warning');
          return;
        }

        const dados = {
          nome: document.getElementById('nomeOS').value.trim(),
          telefone: document.getElementById('telefoneOS').value.replace(/\D/g, ''),
          endereco: document.getElementById('enderecoOS').value.trim(),
          cidade: document.getElementById('cidadeOS').value.trim(),
          email: document.getElementById('emailOS').value.trim(),
          equipamento: document.getElementById('equipamentoOS').value,
          defeito: document.getElementById('defeitoOS').value.trim(),
          data: document.getElementById('dataOS').value,
          hora: document.getElementById('horaOS').value,
          status: document.getElementById('statusOS').value,
          valor: document.getElementById('valorOS').value,
          prazo: document.getElementById('prazoOS').value,
          tecnico: document.getElementById('tecnicoOS').value.trim(),
          garantia: document.getElementById('garantiaOS').value,
          observacoes: document.getElementById('observacoesOS').value.trim()
        };

        if (dados.equipamento === 'Outro') {
          dados.equipamento = document.getElementById('outroEquipamentoOS').value.trim();
          if (!dados.equipamento) {
            mostrarToast('Informe o equipamento', 'warning');
            return;
          }
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="loading" style="width: 16px; height: 16px; margin-right: 8px;"></span> Salvando...';

        fetch('/ordens_servico', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
          },
          body: JSON.stringify(dados)
        })
        .then(res => res.json())
        .then(res => {
          if (res.id || res.protocolo) {
            mostrarToast('✅ OS criada com sucesso! Protocolo: ' + (res.protocolo || res.id), 'success');

            limparFormularioOS();

            todasOrdensCache = null;
            dashboardDataCache = null;
            todasOrdensFiltradas = [];
            frontendCache.clear();

            setTimeout(() => {
              carregarDashboard(true);
              carregarOrdens(true);
              carregarClientes(true);
            }, 1000);

            document.getElementById('resultadoOS').innerHTML = '<div class="alert alert-success"><h5><i class="fas fa-check-circle"></i> Ordem salva com sucesso!</h5><p><strong>Protocolo:</strong> ' + (res.protocolo || res.id) + '</p><button class="btn btn-outline-success btn-sm" onclick="abrirOSDetalhes(\'' + (res.protocolo || res.id) + '\')"><i class="fas fa-external-link-alt"></i> Visualizar OS</button></div>';
          } else {
            mostrarToast('❌ Erro: ' + (res.error || 'Falha ao salvar'), 'danger');
            console.error(res);
          }

          btn.disabled = false;
          btn.innerHTML = originalText;
        })
        .catch(error => {
          mostrarToast('❌ Erro ao salvar OS: ' + error.message, 'danger');
          console.error(error);
          btn.disabled = false;
          btn.innerHTML = originalText;
        });
      }

      function carregarOrdens(forceRefresh = false) {
        const tbody = document.getElementById('tabelaOrdens');
        tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5"><div class="loading" style="width: 30px; height: 30px; margin: 0 auto;"></div><p class="text-muted mt-2">Carregando ordens...</p></td></tr>';

        const cachedData = frontendCache.get('ordens');
        if (!forceRefresh && cachedData) {
          todasOrdensCache = cachedData;
          todasOrdensFiltradas = [...cachedData];
          if (cachedData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><h5>Nenhuma ordem encontrada</h5><p class="mb-0">Comece criando uma nova ordem de serviço</p></td></tr>';
            document.getElementById('paginacaoOrdens').innerHTML = '';
          } else {
            aplicarFiltrosOSLocais();
            renderizarPaginaOrdens(1);
          }
          return;
        }

        fetch('/ordens_servico')
          .then(res => res.json())
          .then(ordens => {
            if (!ordens || !Array.isArray(ordens)) {
              ordens = [];
            }

            todasOrdensCache = ordens;
            todasOrdensFiltradas = [...ordens];
            frontendCache.set('ordens', ordens);

            if (ordens.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x mb-3 opacity-25"></i><h5>Nenhuma ordem encontrada</h5><p class="mb-0">Comece criando uma nova ordem de serviço</p></td></tr>';
              document.getElementById('paginacaoOrdens').innerHTML = '';
              return;
            }

            aplicarFiltrosOSLocais();
            renderizarPaginaOrdens(1);
          })
          .catch(error => {
            console.error('Erro carregar ordens:', error);
            tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-3"></i><h5>Erro ao carregar ordens</h5><p class="mb-0">' + (error.message || 'Erro desconhecido') + '</p></td></tr>';
          });
      }

      function aplicarFiltrosOSLocais() {
        const filtroTexto = document.getElementById('filtroBuscaOS').value.toLowerCase();
        const filtroStatus = document.getElementById('filtroStatusOS').value;
        const filtroMes = document.getElementById('filtroMesOS').value;

        todasOrdensFiltradas = todasOrdensCache.filter(ordem => {
          if (filtroTexto && !(
            (ordem.protocolo && ordem.protocolo.toLowerCase().includes(filtroTexto)) ||
            (ordem.nome && ordem.nome.toLowerCase().includes(filtroTexto)) ||
            (ordem.equipamento && ordem.equipamento.toLowerCase().includes(filtroTexto)) ||
            (ordem.telefone && ordem.telefone.includes(filtroTexto))
          )) {
            return false;
          }

          if (filtroStatus && ordem.status !== filtroStatus) {
            return false;
          }

          if (filtroMes && ordem.data) {
            const partes = ordem.data.split('/');
            if (partes.length >= 2) {
              const mesOrdem = partes[1];
              if (mesOrdem !== filtroMes) {
                return false;
              }
            } else {
              return false;
            }
          }

          return true;
        });
      }

      function filtrarOrdensRapido() {
        aplicarFiltrosOSLocais();
        renderizarPaginaOrdens(1);
      }

      function limparFiltrosOS() {
        document.getElementById('filtroBuscaOS').value = '';
        document.getElementById('filtroStatusOS').value = '';
        document.getElementById('filtroMesOS').value = '';
        todasOrdensFiltradas = [...todasOrdensCache];
        renderizarPaginaOrdens(1);
      }

      function renderizarPaginaOrdens(pagina) {
        paginaAtualOrdens = pagina;
        const tbody = document.getElementById('tabelaOrdens');

        if (todasOrdensFiltradas.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-muted"><i class="fas fa-search fa-2x mb-3 opacity-25"></i><h5>Nenhuma ordem encontrada</h5><p class="mb-0">Tente ajustar os filtros de busca</p></td></tr>';
          document.getElementById('paginacaoOrdens').innerHTML = '';
          return;
        }

        const inicio = (pagina - 1) * itensPorPagina;
        const fim = inicio + itensPorPagina;
        const ordensPagina = todasOrdensFiltradas.slice(inicio, fim);
        const totalPaginas = Math.ceil(todasOrdensFiltradas.length / itensPorPagina);

        let html = '';
        ordensPagina.forEach(ordem => {
          const statusClass = 'status-' + ordem.status.toLowerCase().replace(/[^a-z]/g, '');
          const valor = parseFloat(ordem.valor || 0).toFixed(2);
          const isFavorito = favoritosManager ? favoritosManager.tem(ordem.protocolo) : false;

          html += '<tr onclick="abrirOSDetalhes(\'' + ordem.protocolo + '\')" style="cursor: pointer;">' +
                  '<td><strong class="text-primary">' + ordem.protocolo + ' ' + (isFavorito ? '<i class="fas fa-star text-warning"></i>' : '') + '</strong></td>' +
                  '<td>' + ordem.data + '</td>' +
                  '<td><div class="fw-semibold" style="color: #000000;">' + ordem.nome + '</div><small class="text-muted">' + formatarTelefoneString(ordem.telefone) + '</small></td>' +
                  '<td>' + ordem.equipamento + '</td>' +
                  '<td><span class="status-badge ' + statusClass + '" onclick="event.stopPropagation(); alterarStatusOSModal(\'' + ordem.protocolo + '\')">' + ordem.status + '</span></td>' +
                  '<td class="fw-bold ' + (parseFloat(valor) > 0 ? 'text-success' : 'text-muted') + '">R$ ' + valor + '</td>' +
                  '<td><div class="action-buttons">' +
                  '<button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); abrirOSDetalhes(\'' + ordem.protocolo + '\')" title="Ver detalhes"><i class="fas fa-eye"></i></button>' +
                  '<button class="btn btn-outline-success btn-sm" onclick="event.stopPropagation(); criarOrcamentoRapido(\'' + ordem.protocolo + '\')" title="Criar orçamento"><i class="fas fa-file-invoice-dollar"></i></button>' +
                  '<button class="btn btn-outline-warning btn-sm" onclick="event.stopPropagation(); alterarStatusOSModal(\'' + ordem.protocolo + '\')" title="Alterar status"><i class="fas fa-edit"></i></button>' +
                  '<button class="btn ' + (isFavorito ? 'btn-warning' : 'btn-outline-warning') + ' btn-sm" onclick="event.stopPropagation(); toggleFavorito(\'' + ordem.protocolo + '\', this)" title="' + (isFavorito ? 'Remover dos favoritos' : 'Adicionar aos favoritos') + '"><i class="fas fa-star"></i></button>' +
                  '<button class="btn btn-outline-secondary btn-sm" onclick="event.stopPropagation(); deletarOrdemModal(\'' + ordem.protocolo + '\', ' + ordem.id + ')" title="Excluir Ordem"><i class="fas fa-trash"></i></button>' +
                  '</div></td></tr>';
        });

        tbody.innerHTML = html;
        renderizarPaginacaoOrdens(totalPaginas, pagina);
      }

      function renderizarPaginacaoOrdens(totalPaginas, paginaAtual) {
        const container = document.getElementById('paginacaoOrdens');

        if (totalPaginas <= 1) {
          container.innerHTML = '';
          return;
        }

        let html = '<ul class="pagination justify-content-center">';

        if (paginaAtual > 1) {
          html += '<li class="page-item"><button class="page-link" onclick="renderizarPaginaOrdens(' + (paginaAtual - 1) + ')"><i class="fas fa-chevron-left"></i></button></li>';
        }

        const inicio = Math.max(1, paginaAtual - 2);
        const fim = Math.min(totalPaginas, paginaAtual + 2);

        for (let i = inicio; i <= fim; i++) {
          html += '<li class="page-item ' + (i === paginaAtual ? 'active' : '') + '"><button class="page-link" onclick="renderizarPaginaOrdens(' + i + ')">' + i + '</button></li>';
        }

        if (paginaAtual < totalPaginas) {
          html += '<li class="page-item"><button class="page-link" onclick="renderizarPaginaOrdens(' + (paginaAtual + 1) + ')"><i class="fas fa-chevron-right"></i></button></li>';
        }

        html += '</ul>';
        container.innerHTML = html;
      }

      function abrirOSDetalhes(protocolo) {
        const ordem = todasOrdensCache.find(o => o.protocolo === protocolo);
        if (!ordem) {
          mostrarToast('Ordem não encontrada', 'warning');
          return;
        }

        const isFavorito = favoritosManager ? favoritosManager.tem(protocolo) : false;

        const modalBody = document.getElementById('modalDetalhesBody');
        modalBody.innerHTML = '<div class="row">' +
          '<div class="col-md-6"><h6><i class="fas fa-info-circle me-2"></i>Informações da OS</h6>' +
          '<table class="table table-sm"><tr><td><strong>Protocolo:</strong></td><td>' + ordem.protocolo + ' ' + (isFavorito ? '<i class="fas fa-star text-warning"></i>' : '') + '</td></tr>' +
          '<tr><td><strong>Data:</strong></td><td>' + ordem.data + ' às ' + ordem.hora + '</td></tr>' +
          '<tr><td><strong>Status:</strong></td><td><span class="status-badge status-' + ordem.status.toLowerCase().replace(/[^a-z]/g, '') + '">' + ordem.status + '</span></td></tr>' +
          '<tr><td><strong>Valor:</strong></td><td>R$ ' + parseFloat(ordem.valor || 0).toFixed(2) + '</td></tr>' +
          '<tr><td><strong>Prazo:</strong></td><td>' + (ordem.prazo || 'Não definido') + '</td></tr>' +
          '<tr><td><strong>Garantia:</strong></td><td>' + (ordem.garantia || '90') + ' dias</td></tr>' +
          '<tr><td><strong>Orçamento ID:</strong></td><td>' + (ordem.orcamentoID || 'Nenhum') + '</td></tr></table></div>' +
          '<div class="col-md-6"><h6><i class="fas fa-user me-2"></i>Cliente</h6>' +
          '<table class="table table-sm"><tr><td><strong>Nome:</strong></td><td>' + ordem.nome + '</td></tr>' +
          '<tr><td><strong>Telefone:</strong></td><td>' + formatarTelefoneString(ordem.telefone) + '</td></tr>' +
          '<tr><td><strong>Endereço:</strong></td><td>' + ordem.endereco + '</td></tr>' +
          '<tr><td><strong>Cidade:</strong></td><td>' + ordem.cidade + '</td></tr>' +
          '<tr><td><strong>Email:</strong></td><td>' + (ordem.email || 'Não informado') + '</td></tr></table></div></div>' +
          '<div class="row mt-3"><div class="col-12"><h6><i class="fas fa-tools me-2"></i>Detalhes do Serviço</h6>' +
          '<table class="table table-sm"><tr><td><strong>Equipamento:</strong></td><td>' + ordem.equipamento + '</td></tr>' +
          '<tr><td><strong>Defeito:</strong></td><td>' + ordem.defeito + '</td></tr>' +
          '<tr><td><strong>Observações:</strong></td><td>' + (ordem.observacoes || 'Nenhuma') + '</td></tr>' +
          '<tr><td><strong>Técnico:</strong></td><td>' + (ordem.tecnico || 'Não atribuído') + '</td></tr></table></div></div>' +
          '<div class="mt-4 d-flex justify-content-end gap-2">' +
          '<button class="btn btn-outline-danger" onclick="deletarOrdemModal(\'' + protocolo + '\', ' + ordem.id + ')"><i class="fas fa-trash me-1"></i> Excluir Ordem</button>' +
          '<button class="btn btn-outline-info" onclick="gerarPDFOrdem(\'' + protocolo + '\')"><i class="fas fa-file-pdf me-1"></i> Baixar PDF</button>' +
          '<button class="btn btn-outline-primary" onclick="mostrarModalEnviarPDFOrdem(\'' + protocolo + '\')"><i class="fas fa-envelope me-1"></i> Enviar PDF por Email</button>' +
          '<button class="btn ' + (isFavorito ? 'btn-warning' : 'btn-outline-warning') + '" onclick="toggleFavoritoModal(\'' + protocolo + '\', this)"><i class="fas fa-star me-1"></i> ' + (isFavorito ? 'Remover Favorito' : 'Adicionar Favorito') + '</button>' +
          '<button class="btn btn-primary" onclick="alterarStatusOSModal(\'' + protocolo + '\')"><i class="fas fa-edit me-1"></i> Alterar Status</button></div>';

        const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
        modal.show();
      }

      function toggleFavorito(protocolo, elemento) {
        if (!favoritosManager) return;

        if (favoritosManager.tem(protocolo)) {
          favoritosManager.remover(protocolo);
          elemento.classList.remove('btn-warning');
          elemento.classList.add('btn-outline-warning');
          elemento.title = 'Adicionar aos favoritos';
        } else {
          favoritosManager.adicionar(protocolo);
          elemento.classList.remove('btn-outline-warning');
          elemento.classList.add('btn-warning');
          elemento.title = 'Remover dos favoritos';
        }
      }

      function toggleFavoritoModal(protocolo, elemento) {
        toggleFavorito(protocolo, elemento);
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalDetalhes'));
        if (modal) {
          modal.hide();
          setTimeout(() => abrirOSDetalhes(protocolo), 300);
        }
      }

      function alterarStatusOSModal(protocolo) {
        const ordem = todasOrdensCache.find(o => o.protocolo === protocolo);
        if (!ordem) {
          mostrarToast('Ordem não encontrada', 'warning');
          return;
        }

        document.getElementById('protocoloOSStatus').value = protocolo;
        document.getElementById('novoStatusOS').value = ordem.status;
        document.getElementById('observacoesStatusOS').value = ordem.observacoes || '';

        const modal = new bootstrap.Modal(document.getElementById('modalAlterarStatusOS'));
        modal.show();
      }

      function confirmarAlterarStatusOS() {
        const protocolo = document.getElementById('protocoloOSStatus').value;
        const novoStatus = document.getElementById('novoStatusOS').value;
        const enviarEmail = document.getElementById('enviarEmailStatusOS').value === 'sim';
        const observacoes = document.getElementById('observacoesStatusOS').value;

        const btn = document.querySelector('#modalAlterarStatusOS .btn-primary');
        const originalText = btn.innerHTML;

        btn.disabled = true;
        btn.innerHTML = '<span class="loading" style="width: 16px; height: 16px; margin-right: 8px;"></span> Processando...';

        const id = protocolo.split('-').pop() || protocolo;
        fetch(`/ordens_servico/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + (localStorage.getItem('token') || '')
          },
          body: JSON.stringify({ status: novoStatus, observacoes })
        })
        .then(res => res.json())
        .then(res => {
          if (res.id || res.status) {
            mostrarToast('✅ Status atualizado para ' + novoStatus, 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalAlterarStatusOS')).hide();

            todasOrdensCache = null;
            dashboardDataCache = null;
            frontendCache.clear();

            setTimeout(() => {
              carregarOrdens(true);
              carregarDashboard(true);
            }, 1000);
          } else {
            mostrarToast('❌ Erro: ' + (res.error || 'Falha ao atualizar'), 'danger');
          }
        })
        .catch(error => {
          mostrarToast('❌ Erro: ' + error.message, 'danger');
        })
        .finally(() => {
          btn.disabled = false;
          btn.innerHTML = originalText;
        });
      }

      function criarOrcamentoRapido(protocolo) {
        const ordem = todasOrdensCache.find(o => o.protocolo === protocolo);
        if (!ordem) {
          mostrarToast('Ordem não encontrada', 'warning');
          return;
        }

        // Preencher formulário de orçamento com dados da OS
        document.getElementById('nomeOrcamento').value = ordem.nome || '';
        document.getElementById('telefoneOrcamento').value = formatarTelefoneString(ordem.telefone);
        document.getElementById('enderecoOrcamento').value = ordem.endereco || '';
        document.getElementById('cidadeOrcamento').value = ordem.cidade || '';
        document.getElementById('emailOrcamento').value = ordem.email || '';
        document.getElementById('equipamentoOrcamento').value = ordem.equipamento || '';
        document.getElementById('defeitoOrcamento').value = ordem.defeito || '';
        document.getElementById('observacoesOrcamento').value = ordem.observacoes || '';
        document.getElementById('tecnicoOrcamento').value = ordem.tecnico || '';
        document.getElementById('garantiaOrcamento').value = ordem.garantia || '90';

        // Mudar para aba de orçamentos
        abrirAba('novoOrcamento', null);

        mostrarToast('Formulário preenchido com dados da OS. Complete os campos restantes.', 'info');
      }

      // ========== FUNÇÕES PARA CLIENTES ==========
      function carregarClientes(forceRefresh = false) {
        const tbody = document.getElementById('tabelaClientes');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5"><div class="loading" style="width: 30px; height: 30px; margin: 0 auto;"></div><p class="text-muted mt-2">Carregando clientes...</p></td></tr>';

        const cachedData = frontendCache.get('clientes');
        if (!forceRefresh && cachedData) {
          renderizarClientes(cachedData);
          return;
        }

        fetch('/clientes')
          .then(res => {
            if (!res.ok) {
              console.error('Status HTTP:', res.status, res.statusText);
              throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            return res.json();
          })
          .then(clientes => {
            if (!clientes || !Array.isArray(clientes)) {
              clientes = [];
            }

            todosClientesCache = clientes;
            frontendCache.set('clientes', clientes);
            renderizarClientes(clientes);
          })
          .catch(error => {
            console.error('Erro carregar clientes:', error);
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-3"></i><h5>Erro ao carregar clientes</h5><p>' + error.message + '</p></td></tr>';
          });
      }

      function renderizarClientes(clientes) {
        const tbody = document.getElementById('tabelaClientes');

        if (!clientes || clientes.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-users fa-3x mb-3 opacity-25"></i><h5>Nenhum cliente encontrado</h5></td></tr>';
          return;
        }

        let html = '';
        clientes.forEach(cliente => {
          html += '<tr>' +
                  '<td><strong>' + (cliente.nome || 'Sem nome') + '</strong></td>' +
                  '<td>' + (cliente.telefone ? formatarTelefoneString(cliente.telefone) : 'Sem telefone') + '</td>' +
                  '<td>' + (cliente.cidade || 'Não informada') + '</td>' +
                  '<td><span class="badge bg-primary rounded-pill">' + (cliente.totalOS || 0) + '</span></td>' +
                  '<td>' + (cliente.dataCadastro || '---') + '</td>' +
                  '<td><button class="btn btn-sm btn-outline-primary" onclick="visualizarCliente(\'' + (cliente.telefone || '') + '\')"><i class="fas fa-eye"></i></button></td>' +
                  '</tr>';
        });

        tbody.innerHTML = html;
      }

      function filtrarClientesRapido() {
        const termo = document.getElementById('filtroCliente').value.toLowerCase();
        const apenasComOS = document.getElementById('filtroAtivos').checked;

        let clientesFiltrados = todosClientesCache || [];

        if (termo) {
          clientesFiltrados = clientesFiltrados.filter(cliente =>
            (cliente.nome && cliente.nome.toLowerCase().includes(termo)) ||
            (cliente.telefone && cliente.telefone.includes(termo)) ||
            (cliente.cidade && cliente.cidade.toLowerCase().includes(termo))
          );
        }

        if (apenasComOS) {
          clientesFiltrados = clientesFiltrados.filter(cliente => (cliente.totalOS || 0) > 0);
        }

        renderizarClientes(clientesFiltrados);
      }

      function visualizarCliente(telefone) {
        const cliente = todosClientesCache.find(c => c.telefone === telefone);
        if (!cliente) {
          mostrarToast('Cliente não encontrado', 'warning');
          return;
        }

        const modalBody = '<div class="row">' +
                          '<div class="col-12">' +
                          '<h5>' + (cliente.nome || 'Sem nome') + '</h5>' +
                          '<p><strong>Telefone:</strong> ' + formatarTelefoneString(cliente.telefone) + '</p>' +
                          '<p><strong>Endereço:</strong> ' + (cliente.endereco || 'Não informado') + '</p>' +
                          '<p><strong>Cidade:</strong> ' + (cliente.cidade || 'Não informada') + '</p>' +
                          '<p><strong>Email:</strong> ' + (cliente.email || 'Não informado') + '</p>' +
                          '<p><strong>Total de OS:</strong> ' + (cliente.totalOS || 0) + '</p>' +
                          '</div>' +
                          '</div>';

        document.getElementById('modalDetalhesBody').innerHTML = modalBody;
        document.querySelector('#modalDetalhes .modal-title').textContent = 'Detalhes do Cliente';
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhes'));
        modal.show();
      }

      // ========== FUNÇÕES PARA MODAIS DE CÓPIA ==========
      function abrirModalCriarOrcamentoExistente() {
        const modal = new bootstrap.Modal(document.getElementById('modalCriarOrcamentoExistente'));
        modal.show();
      }

      function abrirModalCriarOSExistente() {
        const modal = new bootstrap.Modal(document.getElementById('modalCriarOSExistente'));
        modal.show();
      }

      function buscarOrcamentoParaCopia(protocolo) {
        if (!protocolo || protocolo.length < 3) {
          document.getElementById('infoProtocoloOrcamentoCopia').innerHTML = '';
          return;
        }

        fetch(`/orcamentos/${protocolo}`)
          .then(res => res.json())
          .then(orcamento => {
            const infoDiv = document.getElementById('infoProtocoloOrcamentoCopia');

            if (!orcamento || orcamento.error) {
              infoDiv.innerHTML = '<div class="alert alert-warning">Orçamento não encontrado</div>';
              return;
            }

            infoDiv.innerHTML = '<div class="alert alert-success"><strong>Orçamento encontrado:</strong><br>' +
                               '<strong>Cliente:</strong> ' + (orcamento.cliente?.nome || orcamento.nome || 'N/A') + '<br>' +
                               '<strong>Telefone:</strong> ' + formatarTelefoneString(orcamento.cliente?.telefone || orcamento.telefone || '') + '<br>' +
                               '<strong>Equipamento:</strong> ' + (orcamento.equipamento || 'N/A') + '<br>' +
                               '<strong>Status:</strong> ' + (orcamento.status || 'N/A') + '<br>' +
                               '<strong>Valor:</strong> R$ ' + parseFloat(orcamento.valor_total || 0).toFixed(2) + '</div>';
          })
          .catch(error => {
            console.error('Erro ao buscar orçamento:', error);
            document.getElementById('infoProtocoloOrcamentoCopia').innerHTML = '<div class="alert alert-danger">Erro ao buscar orçamento</div>';
          });
      }

      function buscarOSParaCopia(protocolo) {
        if (!protocolo || protocolo.length < 3) {
          document.getElementById('infoProtocoloOSCopia').innerHTML = '';
          return;
        }

        fetch(`/ordens_servico/${protocolo}`)
          .then(res => res.json())
          .then(ordem => {
            const infoDiv = document.getElementById('infoProtocoloOSCopia');

            if (!ordem || ordem.error) {
              infoDiv.innerHTML = '<div class="alert alert-warning">Ordem não encontrada</div>';
              return;
            }

            infoDiv.innerHTML = '<div class="alert alert-success"><strong>Ordem encontrada:</strong><br>' +
                               '<strong>Protocolo:</strong> ' + (ordem.protocolo || ordem.id) + '<br>' +
                               '<strong>Status:</strong> ' + (ordem.status || 'N/A') + '<br>' +
                               '<strong>Data:</strong> ' + (ordem.data_criacao ? new Date(ordem.data_criacao).toLocaleDateString('pt-BR') : 'N/A') + '</div>';
          })
          .catch(error => {
            console.error('Erro ao buscar ordem:', error);
            document.getElementById('infoProtocoloOSCopia').innerHTML = '<div class="alert alert-danger">Erro ao buscar ordem</div>';
          });
      }

      function criarOrcamentoAPartirDeProtocoloConfirmar() {
        const protocolo = document.getElementById('inputProtocoloOrcamentoCopia').value;

        if (!protocolo) {
          mostrarToast('Digite um protocolo', 'warning');
          return;
        }

        mostrarToast('⚠️ Funcionalidade em desenvolvimento', 'info');
      }

      function criarOSAPartirDeProtocoloConfirmar() {
        const protocolo = document.getElementById('inputProtocoloOSCopia').value;

        if (!protocolo) {
          mostrarToast('Digite um protocolo', 'warning');
          return;
        }

        mostrarToast('⚠️ Funcionalidade em desenvolvimento', 'info');
      }

      // ========== FUNÇÕES PARA RELATÓRIOS ==========
      function gerarRelatorioMensal() {
        const mes = document.getElementById('relatorioMes').value;
        const ano = document.getElementById('relatorioAno').value;

        if (!mes || !ano) {
          mostrarToast('Selecione mês e ano', 'warning');
          return;
        }

        mostrarToast('⚠️ Funcionalidade em desenvolvimento', 'info');
      }

      function gerarRelatorioFinanceiro() {
        const periodoInicio = document.getElementById('periodoInicio').value;
        const periodoFim = document.getElementById('periodoFim').value;

        if (!periodoInicio || !periodoFim) {
          mostrarToast('Selecione o período', 'warning');
          return;
        }

        mostrarToast('⚠️ Funcionalidade em desenvolvimento', 'info');
      }

      function atualizarGraficoRelatorio(dados) {
        const ctx = document.getElementById('graficoRelatorio').getContext('2d');

        if (graficoRelatorio) {
          graficoRelatorio.destroy();
        }

        const labels = Object.keys(dados.porStatus || {});
        const valores = Object.values(dados.porStatus || {});

        graficoRelatorio = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Quantidade de OS',
              data: valores,
              backgroundColor: [
                '#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'
              ],
              borderColor: [
                '#2980b9', '#27ae60', '#c0392b', '#d35400', '#8e44ad'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              title: {
                display: true,
                text: 'Distribuição de Status das OS'
              }
            }
          }
        });
      }

      function exportarParaPDF() {
        mostrarToast('⚠️ Funcionalidade em desenvolvimento', 'info');
      }

      function exportarParaCSV() {
        mostrarToast('⚠️ Funcionalidade em desenvolvimento', 'info');
      }

      function exportarParaExcel() {
        mostrarToast('Funcionalidade em desenvolvimento', 'info');
      }

      function exportarOrcamentos() {
        mostrarToast('Exportando orçamentos...', 'info');
      }

      function exportarOrdens() {
        mostrarToast('Exportando ordens...', 'info');
      }

      // ========== UTILITÁRIOS AVANÇADOS ==========
      function iniciarAtualizacaoAutomatica() {
        setInterval(() => {
          if (document.getElementById('dashboard').classList.contains('d-none')) return;
          carregarDashboard();
        }, 120000);

        setInterval(verificarConexao, 30000);

        // Atualizar ano do relatório uma vez por dia
        setInterval(configurarAnoRelatorio, 86400000);
      }

      function verificarConexao() {
        const status = document.getElementById('statusConexao');
        // Sempre mostrar online (backend Express está sempre disponível localmente)
        status.innerHTML = '<i class="fas fa-wifi"></i> Online';
        status.className = 'badge bg-success me-3';
      }

      function limparCacheFront() {
        todasOrdensCache = [];
        todasOrdensFiltradas = [];
        todosOrcamentosCache = [];
        todosOrcamentosFiltrados = [];
        todosClientesCache = [];
        dashboardDataCache = null;
        frontendCache.clear();

        mostrarToast('Cache limpo! Recarregando dados...', 'info');

        setTimeout(() => {
          carregarDashboard(true);
          carregarOrcamentos(true);
          carregarOrdens(true);
          carregarClientes(true);
        }, 500);
      }

      function logoutApp() {
        if (confirm('Deseja sair do sistema?')) {
          localStorage.removeItem('token');
          window.location.reload();
        }
      }

      function fazerBackup(event) {
        if (event) {
          event.preventDefault();
          event.stopPropagation();
        }
        mostrarToast('Função de backup em desenvolvimento', 'info');
      }

      // ========== FUNÇÕES AVANÇADAS FRONTEND ==========
      function setupAtalhosTeclado() {
        document.addEventListener('keydown', (e) => {
          // Ctrl + O: Novo Orçamento
          if (e.ctrlKey && e.key === 'o') {
            e.preventDefault();
            abrirAba('novoOrcamento', null);
          }

          // Ctrl + S: Nova OS
          if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            abrirAba('novaOS', null);
          }

          // Ctrl + D: Dashboard
          if (e.ctrlKey && e.key === 'd') {
            e.preventDefault();
            abrirAba('dashboard', null);
          }

          // Ctrl + F: Foco na busca
          if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            const busca = document.getElementById('filtroBuscaOrcamento') ||
                         document.getElementById('filtroBuscaOS') ||
                         document.getElementById('filtroCliente');
            if (busca) {
              busca.focus();
              busca.select();
            }
          }

          // Esc: Fecha modais
          if (e.key === 'Escape') {
            const modais = document.querySelectorAll('.modal.show');
            modais.forEach(modal => {
              const modalInstance = bootstrap.Modal.getInstance(modal);
              if (modalInstance) modalInstance.hide();
            });
          }
        });
      }

      function setupScrollSuave() {
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
          anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            if (targetId && targetId !== '#') {
              const targetElement = document.querySelector(targetId);
              if (targetElement) {
                targetElement.scrollIntoView({
                  behavior: 'smooth',
                  block: 'start'
                });
              }
            }
          });
        });
      }

      function requestNotificationPermission() {
        if ("Notification" in window && Notification.permission === "default") {
          Notification.requestPermission().then(permission => {
            if (permission === "granted") {
              console.log("Permissão para notificações concedida");
            }
          });
        }
      }

      function showDesktopNotification(title, options = {}) {
        if ("Notification" in window && Notification.permission === "granted") {
          const notification = new Notification(title, {
            icon: 'https://cdn-icons-png.flaticon.com/512/3067/3067256.png',
            badge: 'https://cdn-icons-png.flaticon.com/512/3067/3067256.png',
            ...options
          });

          notification.onclick = function() {
            window.focus();
            this.close();
          };

          return notification;
        }
        return null;
      }

      // ========== SISTEMA DE SINCRONIZAÇÃO ==========
      function setupAutoSync() {
        return {
          syncInterval: null,
          lastSync: null,

          start: function(interval = 120000) {
            if (this.syncInterval) {
              clearInterval(this.syncInterval);
            }

            this.syncInterval = setInterval(() => {
              this.performSync();
            }, interval);

            console.log('Sincronização automática iniciada:', interval + 'ms');
          },

          stop: function() {
            if (this.syncInterval) {
              clearInterval(this.syncInterval);
              this.syncInterval = null;
              console.log('Sincronização automática parada');
            }
          },

          performSync: function() {
            if (document.hidden) return;

            const abasAtivas = ['dashboard', 'orcamentos', 'ordens', 'clientes'];
            const abaAtual = document.querySelector('.aba-conteudo:not(.d-none)')?.id;

            if (abaAtual && abasAtivas.includes(abaAtual)) {
              console.log('Sincronização automática para aba:', abaAtual);

              switch(abaAtual) {
                case 'dashboard':
                  carregarDashboard(true);
                  break;
                case 'orcamentos':
                  carregarOrcamentos(true);
                  break;
                case 'ordens':
                  carregarOrdens(true);
                  break;
                case 'clientes':
                  carregarClientes(true);
                  break;
              }

              this.lastSync = new Date();
            }
          },

          forceSync: function() {
            this.performSync();
            mostrarToast('Sincronização forçada realizada', 'info');
          }
        };
      }

      // ========== TOAST NOTIFICAÇÕES ==========
      function mostrarToast(mensagem, tipo = 'info') {
        const tipos = {
          success: { icon: 'check-circle', color: 'success', bg: '#27ae60' },
          danger: { icon: 'exclamation-triangle', color: 'danger', bg: '#e74c3c' },
          warning: { icon: 'exclamation-circle', color: 'warning', bg: '#f39c12' },
          info: { icon: 'info-circle', color: 'info', bg: '#1abc9c' }
        };

        const config = tipos[tipo] || tipos.info;
        const id = 'toast-' + Date.now();

        const toastHTML = '<div id="' + id + '" class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="background: #1a1a2e;">' +
          '<div class="toast-header text-white" style="background: linear-gradient(to right, ' + config.bg + ', rgba(' + 
          (config.bg === '#27ae60' ? '39, 174, 96' : config.bg === '#e74c3c' ? '231, 76, 60' : config.bg === '#f39c12' ? '243, 156, 18' : '26, 188, 156') + 
          ', 0.8)); border-bottom: 1px solid rgba(52, 152, 219, 0.2);">' +
          '<i class="fas fa-' + config.icon + ' me-2"></i>' +
          '<strong class="me-auto">Sistema OS</strong>' +
          '<small>' + new Date().toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}) + '</small>' +
          '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>' +
          '</div>' +
          '<div class="toast-body" style="background: #1a1a2e; color: #e0e0e0;">' + mensagem + '</div>' +
          '</div>';

        const container = document.getElementById('toastContainer');
        const toastEl = document.createElement('div');
        toastEl.innerHTML = toastHTML;
        container.appendChild(toastEl);

        const toast = new bootstrap.Toast(toastEl.firstElementChild);
        toast.show();

        setTimeout(() => {
          if (toastEl.parentNode) {
            toastEl.parentNode.removeChild(toastEl);
          }
        }, 5000);
      }
    </script>
  </body>
</html>
