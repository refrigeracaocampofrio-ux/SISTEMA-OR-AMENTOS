<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendar Visita - RCF Assist√™ncia T√©cnica</title>
  <script src="js/notifier.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="css/header-styles.css">
  <link rel="stylesheet" href="css/system-text-colors.css">
  <style>
    :root {
      --primary: #3498db;
      --secondary: #1a1a2e;
      --success: #27ae60;
      --danger: #e74c3c;
      --warning: #f39c12;
      --info: #1abc9c;
      --dark-bg: #0f0f1e;
      --dark-card: #16213e;
      --dark-sidebar: #1a1a2e;
    }

    body {
      background: var(--dark-bg);
      min-height: 100vh;
      padding: 20px 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #e0e0e0;
    }

    .navbar-top {
      background: var(--dark-sidebar);
      padding: 15px 20px;
      border-bottom: 1px solid rgba(52, 152, 219, 0.3);
      display: flex;
      align-items: center;
      margin-bottom: 30px;
    }

    .navbar-logo {
      height: 50px;
      margin-right: 15px;
      object-fit: contain;
    }

    .navbar-title {
      color: #ffffff;
      font-size: 1.3rem;
      font-weight: bold;
      margin: 0;
    }

    .banner-header {
      background: linear-gradient(135deg, var(--dark-card) 0%, rgba(52, 152, 219, 0.1) 100%);
      padding: 40px 30px;
      border-radius: 0;
      box-shadow: none;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .banner-logo {
      max-width: 500px;
      width: 100%;
      height: auto;
      margin: 0;
      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
      display: block;
    }

    .banner-title {
      color: white;
      font-size: 2rem;
      font-weight: bold;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      display: none;
    }

    .banner-subtitle {
      color: rgba(255, 255, 255, 0.9);
      font-size: 1.1rem;
      margin-top: 10px;
      display: none;
    }

    .main-container {
      max-width: 900px;
      margin: 0 auto;
      background: var(--dark-card);
      border-radius: 0;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      overflow: hidden;
      color: #e0e0e0;
    }

    .content-section {
      padding: 40px;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }

    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 10%;
      right: 10%;
      height: 2px;
      background: rgba(52, 152, 219, 0.2);
      z-index: -1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
      z-index: 1;
    }

    .step-circle {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #444;
      color: #999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
      margin-bottom: 8px;
      transition: all 0.3s;
    }

    .step.active .step-circle {
      background: var(--primary);
      color: white;
      box-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
    }

    .step-label {
      font-size: 0.85rem;
      color: #999;
      text-align: center;
    }

    .step.active .step-label {
      color: var(--primary);
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      color: #bbb;
      font-weight: 500;
      margin-bottom: 8px;
      display: block;
    }

    .form-control, .form-select {
      background: var(--dark-bg);
      border: 1px solid rgba(52, 152, 219, 0.3);
      color: #e0e0e0;
      border-radius: 5px;
      padding: 10px 15px;
      transition: all 0.3s;
    }

    .form-control:focus, .form-select:focus {
      background: var(--dark-bg);
      border-color: var(--primary);
      color: #e0e0e0;
      box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
    }

    .form-control::placeholder {
      color: #666;
    }

    .btn {
      border-radius: 5px;
      font-weight: 500;
      padding: 10px 25px;
      transition: all 0.3s;
      border: none;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-secondary {
      background: #444;
      color: #ddd;
    }

    .btn-secondary:hover {
      background: #555;
      color: white;
    }

    .alert {
      border-radius: 5px;
      border: none;
      margin-bottom: 20px;
    }

    .alert-info {
      background: rgba(52, 152, 219, 0.2);
      color: #5bc0de;
      border-left: 4px solid var(--primary);
    }

    .alert-warning {
      background: rgba(243, 156, 18, 0.2);
      color: #f39c12;
      border-left: 4px solid #f39c12;
    }

    .alert-danger {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border-left: 4px solid #e74c3c;
    }

    .alert-success {
      background: rgba(39, 174, 96, 0.2);
      color: #27ae60;
      border-left: 4px solid #27ae60;
    }

    /* Loading and Success states */
    .loading-spinner {
      display: none;
      text-align: center;
      padding: 40px;
    }
    .loading-spinner.active {
      display: block;
    }
    .success-message {
      display: none;
      text-align: center;
      padding: 40px;
    }
    .success-message.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }
    .success-icon { font-size: 4rem; color: #28a745; margin-bottom: 20px; }

    h2 {
      color: #e0e0e0;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .calendar-container {
      background: var(--dark-bg);
      border-radius: 5px;
      padding: 20px;
      border: 1px solid rgba(52, 152, 219, 0.2);
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      color: #e0e0e0;
    }

    .calendar-header button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .calendar-header button:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    .calendar-day-header {
      text-align: center;
      font-weight: 600;
      color: #9aa4b3;
      padding: 8px 0;
    }

    /* Hor√°rios dispon√≠vel grid */
    .horarios-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .horario-card {
      border: 1px solid rgba(52, 152, 219, 0.3);
      border-radius: 5px;
      padding: 15px;
      background: var(--dark-bg);
      color: #e0e0e0;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .horario-card:hover { border-color: var(--primary); transform: translateY(-2px); }
    .horario-card.selected { background: var(--primary); color: #fff; border-color: var(--primary); }
    .horario-icon { font-size: 1.4rem; margin-bottom: 5px; }

    /* Navega√ß√£o de meses */
    .month-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .month-selector button { background: var(--primary); color: #fff; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; transition: all 0.2s; }
    .month-selector button:hover { background: #2980b9; }

    .calendar-day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(52, 152, 219, 0.2);
      border-radius: 5px;
      cursor: pointer;
      background: var(--dark-bg);
      color: #999;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    .calendar-day:hover {
      border-color: var(--primary);
      color: #e0e0e0;
    }

    .calendar-day.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .calendar-day.disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }

    /* Past days styling and interaction */
    .calendar-day.past {
      opacity: 0.4;
      cursor: not-allowed;
      background: rgba(0, 0, 0, 0.25);
    }

    /* Ensure clicks land on days */
    .calendar-container { position: relative; }
    .calendar-day { pointer-events: auto; user-select: none; }
    .calendar-day.disabled, .calendar-day.past { pointer-events: none; }

    .time-slots {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 20px;
    }

    .time-slot {
      padding: 12px;
      border: 1px solid rgba(52, 152, 219, 0.3);
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      background: var(--dark-bg);
      color: #999;
    }

    .time-slot:hover {
      border-color: var(--primary);
      color: #e0e0e0;
    }

    .time-slot.selected {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .time-slot.unavailable {
      opacity: 0.3;
      cursor: not-allowed;
    }

    .section-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: var(--primary);
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(52, 152, 219, 0.2);
    }

    .confirmation-item {
      background: var(--dark-bg);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 15px;
      border-left: 4px solid var(--primary);
    }

    .confirmation-item strong {
      color: #e0e0e0;
    }

    .confirmation-item span {
      color: #999;
    }

    .step-content {
      display: none;
    }

    .step-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .text-muted {
      color: #999 !important;
    }

    .text-center {
      text-align: center;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark py-2 px-3 border-bottom" style="background: #1a1a2e; border-bottom: 1px solid rgba(52, 152, 219, 0.3) !important;">
    <div class="container-fluid" style="display:flex;align-items:center;">
      <img src="/imagens/logo-rcf.png" alt="RCF Logo" style="height: 50px; margin-right: 15px; object-fit: contain;" onerror="this.onerror=null; this.src='/imagens/logo-rcf.svg';">
      <div>
        <span class="navbar-brand mb-0 h1 fw-bold" style="color: #ffffff; margin: 0;">Refrigera√ß√£o Campo Frio</span>
        <span class="navbar-text d-none d-sm-block ms-3" style="font-size: 11px; color: #ffffff !important;">Created by Marciel</span>
      </div>
    </div>
  </nav>
  <!-- Redireciona para o novo fluxo em 4 telas -->
  <script>
    (function(){
      const novoFluxo = '/agendamento-data.html';
      // Permite abrir o fluxo antigo adicionando ?old=1
      if (!location.search.includes('old=1')) {
        try { window.location.replace(novoFluxo); } catch(e){ window.location.href = novoFluxo; }
      }
    })();
  </script>
  <div style="max-width:900px;margin:40px auto;padding:20px;background:#16213e;border:1px solid rgba(52,152,219,.2);border-radius:8px;color:#e0e0e0;">
    <h4 style="margin:0 0 10px 0;">Migrando para o novo fluxo de agendamento‚Ä¶</h4>
    <p>Se n√£o redirecionar automaticamente, clique no bot√£o abaixo.</p>
    <a class="btn btn-primary" href="/agendamento-data.html">Iniciar Agendamento (4 etapas)</a>
    <a class="btn btn-secondary ms-2" href="/agendamento.html?old=1">Usar fluxo antigo (1 p√°gina)</a>
  </div>
  

  <div class="main-container">
    <!-- Banner Header -->
    <div class="banner-header">
      <img src="/imagens/logo-rcf.png" alt="RCF Assist√™ncia T√©cnica" class="banner-logo" onerror="this.onerror=null; this.src='/imagens/logo-rcf.svg';">
      <h1 class="banner-title">‚ùÑÔ∏è Agende sua Visita</h1>
      <p class="banner-subtitle">Especialistas em Refrigera√ß√£o ‚Ä¢ Atendimento R√°pido e Profissional</p>
    </div>

    <!-- Content Section -->
    <div class="content-section">
      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step active" id="step1-indicator">
          <div class="step-circle">1</div>
          <div class="step-label">Data</div>
        </div>
        <div class="step" id="step2-indicator">
          <div class="step-circle">2</div>
          <div class="step-label">Hor√°rio</div>
        </div>
        <div class="step" id="step3-indicator">
          <div class="step-circle">3</div>
          <div class="step-label">Seus Dados</div>
        </div>
        <div class="step" id="step4-indicator">
          <div class="step-circle">4</div>
          <div class="step-label">Confirma√ß√£o</div>
        </div>
      </div>

      <!-- Alerts -->
      <div id="alertContainer"></div>
      
      <!-- Informa√ß√£o importante -->
      <div class="alert alert-primary">
        <strong><i class="bi bi-info-circle"></i> Sistema de Agendamento:</strong> 
        Apenas 1 visita por hor√°rio para garantir atendimento exclusivo e de qualidade.
      </div>

      <!-- Step 1: Escolher Data -->
      <div class="form-section active" id="step1">
        <h3 class="mb-4"><i class="bi bi-calendar-event"></i> Escolha a Data da Visita</h3>
        
        <div class="month-selector">
          <button onclick="mudarMes(-1)"><i class="bi bi-chevron-left"></i> Anterior</button>
          <h4 id="mesAnoAtual"></h4>
          <button onclick="mudarMes(1)">Pr√≥ximo <i class="bi bi-chevron-right"></i></button>
        </div>
        
        <div class="calendar-container" id="calendario">
          <!-- Calend√°rio ser√° gerado aqui -->
        </div>
        
        <div class="text-end mt-4">
          <button class="btn btn-primary" onclick="proximoPasso(2)" id="btnProximoData" disabled>
            Pr√≥ximo <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </div>

      <!-- Step 2: Escolher Hor√°rio -->
      <div class="form-section" id="step2">
        <h3 class="mb-4"><i class="bi bi-clock"></i> Escolha o Hor√°rio</h3>
        
        <div class="alert alert-info">
          <strong>Data selecionada:</strong> <span id="dataSelecionadaDisplay"></span>
        </div>
        
        <div class="horarios-grid" id="horariosDisponiveis">
          <!-- Hor√°rios ser√£o gerados aqui -->
        </div>
        
        <div class="loading-spinner" id="loadingHorarios">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <p class="mt-3">Carregando hor√°rios dispon√≠veis...</p>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-secondary" onclick="voltarPasso(1)">
            Voltar
          </button>
          <button class="btn btn-primary" onclick="proximoPasso(3)" id="btnProximoHorario" disabled>
            Pr√≥ximo
          </button>
        </div>
      </div>

      <!-- Step 3: Dados do Cliente -->
      <div class="form-section" id="step3">
        <h3 class="mb-4"><i class="bi bi-person-fill"></i> Seus Dados</h3>
        
        <form id="formDados">
          <div class="row mb-3">
            <div class="col-md-12">
              <label class="form-label">Nome Completo *</label>
              <input type="text" class="form-control" id="nome" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="form-label">Email *</label>
              <input type="email" class="form-control" id="email" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Telefone *</label>
              <input type="tel" class="form-control" id="telefone" placeholder="(00) 00000-0000" required>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-8">
              <label class="form-label">Endere√ßo *</label>
              <input type="text" class="form-control" id="endereco" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Complemento</label>
              <input type="text" class="form-control" id="complemento">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-5">
              <label class="form-label">Cidades atendidas *</label>
              <select class="form-control" id="cidadeAtendida" required onchange="atualizarTaxaCidade()">
                <option value="">Selecione</option>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <div>
                <label class="form-label">Taxa</label>
                <div class="form-control bg-dark text-white" id="taxaCidadeDisplay">--</div>
              </div>
            </div>
            <div class="col-md-2">
              <label class="form-label">Estado *</label>
              <select class="form-control" id="estado" required>
                <option value="SP">SP</option>
                <option value="RJ">RJ</option>
                <option value="MG">MG</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">CEP</label>
              <input type="text" class="form-control" id="cep" placeholder="00000-000">
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-12">
              <label class="form-label">Tipo de Servi√ßo</label>
              <select class="form-control" id="tipoServico">
                <option value="">Selecione</option>
                <option value="Ar Condicionado">Ar Condicionado</option>
                <option value="Geladeira">Geladeira</option>
                <option value="Freezer">Freezer</option>
                <option value="C√¢mara Fria">C√¢mara Fria</option>
                <option value="Outro">Outro</option>
              </select>
            </div>
          </div>
          
          <div class="row mb-3">
            <div class="col-md-12">
              <label class="form-label">Descri√ß√£o do Problema</label>
              <textarea class="form-control" id="descricaoProblema" rows="3" placeholder="Descreva brevemente o problema..."></textarea>
            </div>
          </div>
        </form>
        
        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-secondary" onclick="voltarPasso(2)">
            Voltar
          </button>
          <button class="btn btn-primary" onclick="proximoPasso(4)">
            Revisar
          </button>
        </div>
      </div>

      <!-- Step 4: Confirma√ß√£o -->
      <div class="form-section" id="step4">
        <h3 class="mb-4"><i class="bi bi-check-circle"></i> Confirme os Dados</h3>
        
        <div class="alert alert-primary">
          <h5>Resumo do Agendamento</h5>
          <hr>
          <div id="resumoAgendamento"></div>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
          <button class="btn btn-secondary" onclick="voltarPasso(3)">
            Voltar
          </button>
          <button class="btn btn-success btn-lg" onclick="confirmarAgendamento()">
            <i class="bi bi-check-lg"></i> Confirmar Agendamento
          </button>
        </div>
      </div>

      <!-- Loading -->
      <div class="loading-spinner" id="loadingConfirmacao">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Processando...</span>
        </div>
        <p class="mt-3">Confirmando seu agendamento...</p>
      </div>

      <!-- Success Message -->
      <div class="success-message" id="successMessage">
        <div class="success-icon">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <h3>Agendamento Confirmado!</h3>
        <p class="lead">Voc√™ receber√° um email de confirma√ß√£o em instantes.</p>
        <p>Aguardamos sua visita!</p>
        <button class="btn btn-primary mt-3" onclick="window.location.reload()">
          Fazer Novo Agendamento
        </button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let dataSelecionada = null;
    let horarioSelecionado = null;
    let mesAtual = new Date();
    
    // Inicializar
    document.addEventListener('DOMContentLoaded', function() {
      gerarCalendario();
      aplicarMascaras();
      popularCidades(); // Initialize cities
      atualizarTaxaCidade(); // Update city fee display
    });
    
    // Taxas por cidade
    const taxasCidade = {
      'campo limpo paulista': 25,
      'botujuru': 35,
      'jarinu': 50,
      'varzea': 50,
      'jundiai': 50,
      'louveira': 50,
      'santana de parnaiba': 80,
      'itupeva': 70,
      'itatiba': 70,
      'cajamar': 60,
    };

    function popularCidades() {
      const select = document.getElementById('cidadeAtendida');
      Object.keys(taxasCidade).forEach(cidade => {
        const opt = document.createElement('option');
        opt.value = cidade;
        opt.textContent = cidade.toUpperCase();
        select.appendChild(opt);
      });
    }

    function atualizarTaxaCidade() {
      const select = document.getElementById('cidadeAtendida');
      const taxaEl = document.getElementById('taxaCidadeDisplay');
      const cidade = (select.value || '').toLowerCase();
      const taxa = taxasCidade[cidade];
      if (taxa !== undefined) {
        taxaEl.textContent = `R$ ${Number(taxa).toFixed(2)}`;
        taxaEl.dataset.valor = Number(taxa).toFixed(2);
      } else {
        taxaEl.textContent = '--';
        taxaEl.dataset.valor = '';
      }
    }

    // Inicializar cidades ao carregar
    document.addEventListener('DOMContentLoaded', () => {
      popularCidades();
      atualizarTaxaCidade();
    });
    // Gerar calend√°rio
    function gerarCalendario() {
      const cal = document.getElementById('calendario');
      cal.innerHTML = '';
      
      // Atualizar t√≠tulo do m√™s
      const meses = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho',
                     'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
      document.getElementById('mesAnoAtual').textContent = 
        `${meses[mesAtual.getMonth()]} ${mesAtual.getFullYear()}`;
      
      // Headers dos dias
      ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'].forEach(dia => {
        const header = document.createElement('div');
        header.className = 'calendar-day-header';
        header.textContent = dia;
        cal.appendChild(header);
      });
      
      // Primeiro dia do m√™s
      const primeiroDia = new Date(mesAtual.getFullYear(), mesAtual.getMonth(), 1);
      const ultimoDia = new Date(mesAtual.getFullYear(), mesAtual.getMonth() + 1, 0);
      
      // Dias em branco antes do primeiro dia
      for (let i = 0; i < primeiroDia.getDay(); i++) {
        cal.appendChild(document.createElement('div'));
      }
      
      // Dias do m√™s
      const hoje = new Date();
      hoje.setHours(0, 0, 0, 0);
      
      for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
        const diaDiv = document.createElement('div');
        diaDiv.className = 'calendar-day';
        diaDiv.textContent = dia;
        
        const dataAtual = new Date(mesAtual.getFullYear(), mesAtual.getMonth(), dia);
        const diaSemana = dataAtual.getDay();
        
        // Verificar se √© passado
        if (dataAtual < hoje) {
          diaDiv.classList.add('past');
        }
        // Verificar se √© domingo (n√£o atende)
        else if (diaSemana === 0) {
          diaDiv.classList.add('disabled');
          diaDiv.title = 'N√£o atendemos aos domingos';
        }
        else {
          // Tornar acess√≠vel e clic√°vel
          diaDiv.setAttribute('role', 'button');
          diaDiv.setAttribute('tabindex', '0');
          diaDiv.addEventListener('click', () => selecionarData(dataAtual, diaDiv));
          diaDiv.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') selecionarData(dataAtual, diaDiv);
          });
        }
        
        cal.appendChild(diaDiv);
      }
    }
    
    function mudarMes(direcao) {
      mesAtual = new Date(mesAtual.getFullYear(), mesAtual.getMonth() + direcao, 1);
      dataSelecionada = null;
      document.getElementById('btnProximoData').disabled = true;
      gerarCalendario();
    }
    
    function selecionarData(data, elemento) {
      // Remover sele√ß√£o anterior
      document.querySelectorAll('.calendar-day.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Adicionar nova sele√ß√£o
      elemento.classList.add('selected');
      dataSelecionada = data;
      document.getElementById('btnProximoData').disabled = false;
    }
    
    async function carregarHorarios() {
      const container = document.getElementById('horariosDisponiveis');
      const loading = document.getElementById('loadingHorarios');
      
      container.style.display = 'none';
      loading.classList.add('active');
      
      try {
        const dataFormatada = dataSelecionada.toISOString().split('T')[0];
        const response = await fetch(`/agendamentos/horarios-disponiveis/${dataFormatada}`);
        const horarios = await response.json();
        
        container.innerHTML = '';
        
        if (horarios.length === 0) {
          container.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-triangle"></i> Nenhum hor√°rio dispon√≠vel para esta data. Todos os hor√°rios j√° foram reservados.</div>';
        } else {
          // Adicionar aviso informativo
          const info = document.createElement('div');
          info.className = 'alert alert-info mb-3';
          info.style.gridColumn = '1 / -1';
          info.innerHTML = '<i class="bi bi-info-circle"></i> <strong>Importante:</strong> Apenas 1 pessoa por hor√°rio. Os hor√°rios mostrados est√£o dispon√≠veis.';
          container.appendChild(info);
          
          horarios.forEach(horario => {
            const card = document.createElement('div');
            card.className = 'horario-card';
            card.innerHTML = `
              <div class="horario-icon"><i class="bi bi-clock"></i></div>
              <div><strong>${horario.inicio}</strong> - ${horario.fim}</div>
              <small style="color: #28a745; margin-top: 5px;">‚úì Dispon√≠vel</small>
            `;
            card.onclick = () => selecionarHorario(horario, card);
            container.appendChild(card);
          });
        }
        
        loading.classList.remove('active');
        container.style.display = 'grid';
      } catch (error) {
        mostrarAlerta('Erro ao carregar hor√°rios. Tente novamente.', 'danger');
        loading.classList.remove('active');
      }
    }
    
    function selecionarHorario(horario, elemento) {
      document.querySelectorAll('.horario-card.selected').forEach(el => {
        el.classList.remove('selected');
      });
      
      elemento.classList.add('selected');
      horarioSelecionado = horario;
      document.getElementById('btnProximoHorario').disabled = false;
    }
    
    function proximoPasso(passo) {
      // Valida√ß√µes
      if (passo === 2 && !dataSelecionada) return;
      if (passo === 3 && !horarioSelecionado) return;
      if (passo === 4 && !validarFormulario()) return;
      
      // Ocultar todas as se√ß√µes
      document.querySelectorAll('.form-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Atualizar indicadores
      for (let i = 1; i <= 4; i++) {
        const indicator = document.getElementById(`step${i}-indicator`);
        indicator.classList.remove('active', 'completed');
        if (i < passo) indicator.classList.add('completed');
        if (i === passo) indicator.classList.add('active');
      }
      
      // Mostrar nova se√ß√£o
      document.getElementById(`step${passo}`).classList.add('active');
      
      // A√ß√µes espec√≠ficas
      if (passo === 2) {
        const dataFormatada = dataSelecionada.toLocaleDateString('pt-BR');
        document.getElementById('dataSelecionadaDisplay').textContent = dataFormatada;
        carregarHorarios();
      }
      
      if (passo === 4) {
        mostrarResumo();
      }
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function voltarPasso(passo) {
      proximoPasso(passo);
    }
    
    function validarFormulario() {
      const campos = ['nome', 'email', 'telefone', 'endereco', 'cidadeAtendida', 'estado'];
      for (const campo of campos) {
        const valor = document.getElementById(campo).value.trim();
        if (!valor) {
          mostrarAlerta(`Por favor, preencha o campo ${campo}`, 'warning');
          return false;
        }
      }
      return true;
    }
    
    function mostrarResumo() {
      const resumo = document.getElementById('resumoAgendamento');
      const dataFormatada = dataSelecionada.toLocaleDateString('pt-BR', { 
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
      });
      const cidadeSel = document.getElementById('cidadeAtendida').value;
      const taxaCidade = document.getElementById('taxaCidadeDisplay').textContent;
      
      resumo.innerHTML = `
        <p><strong>üìÖ Data:</strong> ${dataFormatada}</p>
        <p><strong>üïê Hor√°rio:</strong> ${horarioSelecionado.inicio} √†s ${horarioSelecionado.fim}</p>
        <p><strong>üë§ Nome:</strong> ${document.getElementById('nome').value}</p>
        <p><strong>üìß Email:</strong> ${document.getElementById('email').value}</p>
        <p><strong>üì± Telefone:</strong> ${document.getElementById('telefone').value}</p>
        <p><strong>üìç Endere√ßo:</strong> ${document.getElementById('endereco').value}${document.getElementById('complemento').value ? ', ' + document.getElementById('complemento').value : ''}</p>
        <p><strong>üèôÔ∏è Cidade/Estado:</strong> ${cidadeSel} - ${document.getElementById('estado').value} (${taxaCidade})</p>
        ${document.getElementById('tipoServico').value ? `<p><strong>üîß Servi√ßo:</strong> ${document.getElementById('tipoServico').value}</p>` : ''}
        ${document.getElementById('descricaoProblema').value ? `<p><strong>üìù Descri√ß√£o:</strong> ${document.getElementById('descricaoProblema').value}</p>` : ''}
      `;
    }
    
    async function confirmarAgendamento() {
      // Esconder formul√°rio
      document.getElementById('step4').classList.remove('active');
      document.getElementById('loadingConfirmacao').classList.add('active');
      
      try {
        const dados = {
          nome: document.getElementById('nome').value,
          email: document.getElementById('email').value,
          telefone: document.getElementById('telefone').value,
          endereco: document.getElementById('endereco').value,
          complemento: document.getElementById('complemento').value,
          cidade: document.getElementById('cidadeAtendida').value,
          estado: document.getElementById('estado').value,
          cep: document.getElementById('cep').value,
          data_agendamento: dataSelecionada.toISOString().split('T')[0],
          horario_inicio: horarioSelecionado.inicio,
          horario_fim: horarioSelecionado.fim,
          tipo_servico: document.getElementById('tipoServico').value,
          descricao_problema: `${document.getElementById('descricaoProblema').value}\nTaxa cidade (${document.getElementById('cidadeAtendida').value}): R$ ${document.getElementById('taxaCidadeDisplay').dataset.valor || '0'}`
        };
        
        const response = await fetch('/agendamentos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(dados)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          document.getElementById('loadingConfirmacao').classList.remove('active');
          document.getElementById('successMessage').classList.add('active');
          
          // Atualizar todos os indicadores para completado
          for (let i = 1; i <= 4; i++) {
            document.getElementById(`step${i}-indicator`).classList.add('completed');
          }
        } else {
          // Tratamento especial para hor√°rio ocupado
          if (result.code === 'HORARIO_OCUPADO') {
            throw new Error('‚ö†Ô∏è Este hor√°rio acabou de ser reservado por outra pessoa. Por favor, escolha outro hor√°rio.');
          } else {
            throw new Error(result.error || 'Erro ao confirmar agendamento');
          }
        }
      } catch (error) {
        document.getElementById('loadingConfirmacao').classList.remove('active');
        
        // Se for erro de hor√°rio ocupado, volta para sele√ß√£o de hor√°rio
        if (error.message.includes('hor√°rio')) {
          document.getElementById('step2').classList.add('active');
          proximoPasso(2);
          mostrarAlerta(error.message, 'warning');
        } else {
          document.getElementById('step4').classList.add('active');
          mostrarAlerta('Erro ao confirmar agendamento: ' + error.message, 'danger');
        }
      }
    }
    
    function mostrarAlerta(mensagem, tipo) {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `
        <div class="alert alert-${tipo} alert-dismissible fade show" role="alert">
          ${mensagem}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }
    
    function aplicarMascaras() {
      // M√°scara de telefone
      document.getElementById('telefone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length <= 10) {
          value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
        } else {
          value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
        e.target.value = value;
      });
      
      // M√°scara de CEP
      document.getElementById('cep').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
        e.target.value = value;
      });
    }
  </script>
</body>
</html>
