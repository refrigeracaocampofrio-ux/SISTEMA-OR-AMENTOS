<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento â€“ ConfirmaÃ§Ã£o</title>
  <script src="js/notifier.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/header-styles.css">
  <link rel="stylesheet" href="css/system-text-colors.css">
  <style>
    :root { --primary:#3498db; --dark-bg:#0f0f1e; --dark-card:#16213e; --dark-sidebar:#1a1a2e; }
    body { background: var(--dark-bg); color:#e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .navbar-top{background:#1a1a2e; padding:12px 18px; border-bottom:1px solid rgba(52,152,219,0.3); display:flex; align-items:center; }
    .navbar-top img{ height:40px; margin-right:12px; }
    .container-box{ max-width:900px; margin:24px auto; background:var(--dark-card); border:1px solid rgba(52,152,219,0.2); border-radius:8px; }
    .box-header{ padding:18px; border-bottom:1px solid rgba(52,152,219,0.2); }
    .box-body{ padding:18px; }
    .success{ text-align:center; padding:24px; display:none; }
    .fee-modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.65); display:none; align-items:center; justify-content:center; z-index:1050; }
    .fee-modal{ background:#16213e; border:1px solid rgba(52,152,219,0.35); border-radius:10px; max-width:520px; width:100%; padding:22px; box-shadow:0 12px 30px rgba(0,0,0,0.4); color:#e0e0e0; }
    .fee-modal h5{ color:#fff; margin-bottom:12px; }
    .fee-modal .fee-text{ background:rgba(52,152,219,0.08); border:1px solid rgba(52,152,219,0.25); border-radius:8px; padding:12px; margin-bottom:16px; }
    .fee-actions{ display:flex; gap:10px; justify-content:flex-end; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark py-2 px-3 border-bottom" style="background: var(--dark-sidebar); border-bottom: 1px solid rgba(52, 152, 219, 0.3) !important;">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <img src="/imagens/logo-rcf.png" alt="RCF Logo" style="height: 50px; margin-right: 15px; object-fit: contain;" onerror="this.onerror=null; this.src='/imagens/logo-rcf.svg';">
        <div>
          <span class="navbar-brand mb-0 h1 fw-bold" style="color: #ffffff; margin: 0;">RefrigeraÃ§Ã£o Campo Frio</span>
          <span class="navbar-text d-none d-sm-block ms-3" style="font-size: 11px; color: #ffffff !important;">Created by Marciel</span>
        </div>
      </div>
    </div>
  </nav>
  <div class="container-box">
    <div class="box-header"><h4 class="m-0">ConfirmaÃ§Ã£o</h4></div>
    <div class="box-body">
      <div id="resumo" class="alert alert-primary"></div>
      <div class="fee-modal-backdrop" id="feeModal">
        <div class="fee-modal">
          <h5>Taxa de deslocamento</h5>
          <div class="fee-text" id="feeText"></div>
          <p class="mb-3">Cobramos essa taxa para cobrir combustÃ­vel e custos de deslocamento. VocÃª confirma a taxa para seguir com o agendamento?</p>
          <div class="fee-actions">
            <button id="btnRecusarTaxa" class="btn btn-outline-light">Falar no WhatsApp</button>
            <button id="btnAceitarTaxa" class="btn btn-success">Confirmar taxa e agendar</button>
          </div>
        </div>
      </div>
      <div class="d-flex justify-content-between">
        <a class="btn btn-secondary" href="/agendamento-dados.html">Voltar</a>
        <button id="btnConfirmar" class="btn btn-success">Confirmar Agendamento</button>
      </div>
      <div id="loading" class="text-center mt-3" style="display:none;">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2">Confirmando...</p>
      </div>
      <div id="sucesso" class="success">
        <h3>Agendamento Confirmado!</h3>
        <p class="lead">VocÃª receberÃ¡ um email de confirmaÃ§Ã£o.</p>
        <div class="d-grid gap-2 mt-3">
          <a id="whatsappLink" class="btn btn-success" target="_blank" rel="noopener">Abrir no WhatsApp</a>
          <small class="text-muted">Vamos redirecionar automaticamente em instantes.</small>
          <a class="btn btn-primary" href="/agendamento-data.html">Novo Agendamento</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    const k='agendamentoDraft';
    function getDraft(){ return JSON.parse(localStorage.getItem(k) || '{}'); }
    function clearDraft(){ localStorage.removeItem(k); }
    const d=getDraft(); if(!d.data_agendamento || !d.horario_inicio || !d.nome){ window.location.href='/agendamento-data.html'; }
    const dataBR = new Date(d.data_agendamento+'T00:00:00').toLocaleDateString('pt-BR');
    const taxa = typeof d.taxa_deslocamento === 'number' ? d.taxa_deslocamento : null;
    document.getElementById('resumo').innerHTML = `
      <p><strong>ğŸ“… Data:</strong> ${dataBR}</p>
      <p><strong>ğŸ• HorÃ¡rio:</strong> ${d.horario_inicio} Ã s ${d.horario_fim}</p>
      <p><strong>ğŸ‘¤ Nome:</strong> ${d.nome}</p>
      <p><strong>ğŸ“§ Email:</strong> ${d.email}</p>
      <p><strong>ğŸ“± Telefone:</strong> ${d.telefone}</p>
      <p><strong>ğŸ“ EndereÃ§o:</strong> ${d.endereco}${d.complemento?(', '+d.complemento):''}</p>
      <p><strong>ğŸ™ï¸ Cidade/Estado:</strong> ${d.cidade} - ${d.estado}</p>
      ${d.tipo_servico?`<p><strong>ğŸ”§ ServiÃ§o:</strong> ${d.tipo_servico}</p>`:''}
      ${d.descricao_problema?`<p><strong>ğŸ“ DescriÃ§Ã£o:</strong> ${d.descricao_problema}</p>`:''}
      ${taxa!==null?`<p><strong>ğŸš— Taxa de deslocamento estimada:</strong> R$ ${taxa.toFixed(2)}</p>`:`<p><strong>ğŸš— Taxa de deslocamento:</strong> a confirmar pelo WhatsApp</p>`}
    `;

    function openFeeModal(){
      const feeText = document.getElementById('feeText');
      if(taxa!==null){
        feeText.textContent = `Cidade selecionada: ${d.cidade}. Taxa estimada: R$ ${taxa.toFixed(2)}.`;
      }else{
        feeText.textContent = `Cidade selecionada: ${d.cidade}. Taxa sob consulta â€” vamos alinhar pelo WhatsApp.`;
      }
      document.getElementById('feeModal').style.display='flex';
    }

    function closeFeeModal(){ document.getElementById('feeModal').style.display='none'; }

    async function confirmar(){
      document.getElementById('btnConfirmar').disabled=true; document.getElementById('loading').style.display='block';
      const payload = {
        nome:d.nome, email:d.email, telefone:d.telefone, endereco:d.endereco, complemento:d.complemento||'',
        cidade:d.cidade, estado:d.estado, cep:d.cep||'', data_agendamento:d.data_agendamento,
        horario_inicio:d.horario_inicio, horario_fim:d.horario_fim, tipo_servico:d.tipo_servico||'',
        descricao_problema:d.descricao_problema||''
      };
      try{
        const res = await fetch('/agendamentos', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const json = await res.json();
        if(!res.ok || !json.success){ throw new Error(json.error || 'Erro ao confirmar'); }
        document.getElementById('loading').style.display='none';
        document.getElementById('sucesso').style.display='block';
        // Monta redirecionamento para WhatsApp da empresa (fixo)
        const empresaWhatsApp = '5511980163597';
        const msg = encodeURIComponent(`OlÃ¡! Meu agendamento foi confirmado:\n\nğŸ“… Data: ${dataBR}\nğŸ• HorÃ¡rio: ${d.horario_inicio}\nğŸ‘¤ Nome: ${d.nome}\nğŸ“± Telefone: ${d.telefone}`);
        const waUrl = `https://wa.me/${empresaWhatsApp}?text=${msg}`;
        const link = document.getElementById('whatsappLink');
        if (link) link.href = waUrl;
        setTimeout(()=>{ window.location.href = waUrl; }, 1200);
        clearDraft();
      }catch(err){
        document.getElementById('loading').style.display='none';
        alert(err.message);
        document.getElementById('btnConfirmar').disabled=false;
      }
    }
    const whatsappNumber = '5511980163597';
    function redirectWhatsAppTaxa(){
      const msg = encodeURIComponent('quero falar com o humano sobre a taxa de deslocamento');
      window.location.href = `https://wa.me/${whatsappNumber}?text=${msg}`;
    }

    document.getElementById('btnConfirmar').onclick = openFeeModal;
    document.getElementById('btnRecusarTaxa').onclick = ()=>{ closeFeeModal(); redirectWhatsAppTaxa(); };
    document.getElementById('btnAceitarTaxa').onclick = ()=>{ closeFeeModal(); confirmar(); };
  </script>
</body>
</html>
