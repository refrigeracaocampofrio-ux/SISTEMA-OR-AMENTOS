<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento â€“ ConfirmaÃ§Ã£o</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --primary:#3498db; --dark-bg:#0f0f1e; --dark-card:#16213e; --dark-sidebar:#1a1a2e; }
    body { background: var(--dark-bg); color:#e0e0e0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .navbar-top{background:#1a1a2e; padding:12px 18px; border-bottom:1px solid rgba(52,152,219,0.3); display:flex; align-items:center; }
    .navbar-top img{ height:40px; margin-right:12px; }
    .container-box{ max-width:900px; margin:24px auto; background:var(--dark-card); border:1px solid rgba(52,152,219,0.2); border-radius:8px; }
    .box-header{ padding:18px; border-bottom:1px solid rgba(52,152,219,0.2); }
    .box-body{ padding:18px; }
    .success{ text-align:center; padding:24px; display:none; }
  </style>
</head>
<body>
  <nav class="navbar navbar-dark py-2 px-3 border-bottom" style="background: var(--dark-sidebar); border-bottom: 1px solid rgba(52, 152, 219, 0.3) !important;">
    <div class="container-fluid">
      <div class="d-flex align-items-center">
        <img src="/imagens/logo-rcf.png" alt="RCF Logo" style="height: 50px; margin-right: 15px; object-fit: contain;" onerror="this.onerror=null; this.src='/imagens/logo-rcf.svg';">
        <div>
          <span class="navbar-brand mb-0 h1 fw-bold" style="color: #ffffff; margin: 0;">RefrigeraÃ§Ã£o Campo Frio</span>
          <span class="navbar-text d-none d-sm-block ms-3" style="font-size: 11px; color: #ffffff !important;">Created by Marciel</span>
        </div>
      </div>
    </div>
  </nav>
  <div class="container-box">
    <div class="box-header"><h4 class="m-0">ConfirmaÃ§Ã£o</h4></div>
    <div class="box-body">
      <div id="resumo" class="alert alert-primary"></div>
      <div class="d-flex justify-content-between">
        <a class="btn btn-secondary" href="/agendamento-dados.html">Voltar</a>
        <button id="btnConfirmar" class="btn btn-success">Confirmar Agendamento</button>
      </div>
      <div id="loading" class="text-center mt-3" style="display:none;">
        <div class="spinner-border text-primary"></div>
        <p class="mt-2">Confirmando...</p>
      </div>
      <div id="sucesso" class="success">
        <h3>Agendamento Confirmado!</h3>
        <p class="lead">VocÃª receberÃ¡ um email de confirmaÃ§Ã£o.</p>
        <div class="d-grid gap-2 mt-3">
          <a id="whatsappLink" class="btn btn-success" target="_blank" rel="noopener">Abrir no WhatsApp</a>
          <small class="text-muted">Vamos redirecionar automaticamente em instantes.</small>
          <a class="btn btn-primary" href="/agendamento-data.html">Novo Agendamento</a>
        </div>
      </div>
    </div>
  </div>
  <script>
    const k='agendamentoDraft';
    function getDraft(){ return JSON.parse(localStorage.getItem(k) || '{}'); }
    function clearDraft(){ localStorage.removeItem(k); }
    const d=getDraft(); if(!d.data_agendamento || !d.horario_inicio || !d.nome){ window.location.href='/agendamento-data.html'; }
    const dataBR = new Date(d.data_agendamento+'T00:00:00').toLocaleDateString('pt-BR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    document.getElementById('resumo').innerHTML = `
      <p><strong>ğŸ“… Data:</strong> ${dataBR}</p>
      <p><strong>ğŸ• HorÃ¡rio:</strong> ${d.horario_inicio} Ã s ${d.horario_fim}</p>
      <p><strong>ğŸ‘¤ Nome:</strong> ${d.nome}</p>
      <p><strong>ğŸ“§ Email:</strong> ${d.email}</p>
      <p><strong>ğŸ“± Telefone:</strong> ${d.telefone}</p>
      <p><strong>ğŸ“ EndereÃ§o:</strong> ${d.endereco}${d.complemento?(', '+d.complemento):''}</p>
      <p><strong>ğŸ™ï¸ Cidade/Estado:</strong> ${d.cidade} - ${d.estado}</p>
      ${d.tipo_servico?`<p><strong>ğŸ”§ ServiÃ§o:</strong> ${d.tipo_servico}</p>`:''}
      ${d.descricao_problema?`<p><strong>ğŸ“ DescriÃ§Ã£o:</strong> ${d.descricao_problema}</p>`:''}
    `;

    async function confirmar(){
      document.getElementById('btnConfirmar').disabled=true; document.getElementById('loading').style.display='block';
      const payload = {
        nome:d.nome, email:d.email, telefone:d.telefone, endereco:d.endereco, complemento:d.complemento||'',
        cidade:d.cidade, estado:d.estado, cep:d.cep||'', data_agendamento:d.data_agendamento,
        horario_inicio:d.horario_inicio, horario_fim:d.horario_fim, tipo_servico:d.tipo_servico||'',
        descricao_problema:d.descricao_problema||''
      };
      try{
        const res = await fetch('/agendamentos', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const json = await res.json();
        if(!res.ok || !json.success){ throw new Error(json.error || 'Erro ao confirmar'); }
        document.getElementById('loading').style.display='none';
        document.getElementById('sucesso').style.display='block';
        // Monta redirecionamento para WhatsApp da empresa (fixo)
        const empresaWhatsApp = '5511980163597';
        const msg = encodeURIComponent(`OlÃ¡! Meu agendamento foi confirmado:\n\nğŸ“… Data: ${dataBR}\nğŸ• HorÃ¡rio: ${d.horario_inicio}\nğŸ‘¤ Nome: ${d.nome}\nğŸ“± Telefone: ${d.telefone}`);
        const waUrl = `https://wa.me/${empresaWhatsApp}?text=${msg}`;
        const link = document.getElementById('whatsappLink');
        if (link) link.href = waUrl;
        setTimeout(()=>{ window.location.href = waUrl; }, 1200);
        clearDraft();
      }catch(err){
        document.getElementById('loading').style.display='none';
        alert(err.message);
        document.getElementById('btnConfirmar').disabled=false;
      }
    }

    document.getElementById('btnConfirmar').onclick = confirmar;
  </script>
</body>
</html>
